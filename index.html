<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Metis: Knowledge Compounding Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #4285F4;
            --primary-dark: #3367D6;
            --background-color: #f0f4f9;
            --surface-color: #ffffff;
            --text-color: #3c4043;
            --text-light-color: #5f6368;
            --border-color: #dadce0;
            --font-family: 'Noto Sans KR', sans-serif;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            --border-radius: 8px;
            /* ìƒíƒœë³„ ìƒ‰ìƒ ì •ì˜ */
            --color-healthy: #34A853; /* ì´ˆë¡ */
            --color-needs-care: #FBBC04; /* ë…¸ë‘ */
            --color-urgent: #EA4335; /* ë¹¨ê°• */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 240px; background-color: var(--surface-color); padding: 24px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .sidebar h1 { font-size: 24px; color: var(--primary-color); margin-bottom: 32px; }
        .sidebar nav { display: flex; flex-direction: column; gap: 8px; }
        .nav-btn { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--border-radius); border: none; background-color: transparent; cursor: pointer; text-align: left; font-size: 16px; font-weight: 500; color: var(--text-light-color); transition: background-color 0.2s, color 0.2s; }
        .nav-btn .icon { font-size: 20px; }
        .nav-btn:hover { background-color: var(--background-color); }
        .nav-btn.active { background-color: #E8F0FE; color: var(--primary-dark); }
        .main-content { flex: 1; overflow-y: auto; padding: 32px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        .view-header { margin-bottom: 24px; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
        .view-header h2 { font-size: 28px; margin-bottom: 4px; }
        .view-header p { color: var(--text-light-color); font-size: 16px; }
        .card { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 24px; margin-bottom: 24px; }
        .btn { padding: 10px 20px; font-size: 16px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--surface-color); cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn:hover { background-color: #f1f3f4; }
        .btn.active { background-color: #E8F0FE; color: var(--primary-dark); border-color: var(--primary-color); }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-secondary { background-color: transparent; color: var(--text-light-color); border: none; }
        .btn-secondary:hover { background-color: #f1f3f4; color: var(--text-color); }
        textarea, input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-family: var(--font-family); font-size: 16px; margin-bottom: 16px; }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus { outline: 2px solid var(--primary-color); border-color: var(--primary-color); }
        textarea { min-height: 120px; resize: vertical; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .main-book-slot { grid-column: 1 / 2; grid-row: 1 / 3; }
        .book-info { display: flex; gap: 20px; margin-bottom: 24px; }
        .book-cover { width: 150px; height: auto; object-fit: cover; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .book-details h4 { font-size: 20px; }
        .book-details .goal { margin-top: 16px; }
        .main-book-slot .btn-primary { width: 100%; padding: 16px; font-size: 18px; }
        .sub-book-shelf-container { grid-column: 2 / 3; }
        .sub-book-shelf { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; }
        .sub-book-cover { height: 120px; border-radius: 4px; box-shadow: var(--shadow); }
        .ai-assistant-slot .book-title-input { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        
        .course-selection { margin-top: 16px; }
        .course-selection h5 { margin-bottom: 8px; color: var(--text-light-color); }
        .course-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .course-btn { flex-grow: 1; }
        
        /* ì§€ì‹ ì •ì› & ê¸°ì–µ ê³¡ì„  ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
        .garden-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 24px; }
        .plant-card { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); border-left: 5px solid; padding: 16px; transition: all 0.2s; cursor: pointer; }
        .plant-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .plant-card.healthy { border-left-color: var(--color-healthy); }
        .plant-card.needs-care { border-left-color: var(--color-needs-care); }
        .plant-card.urgent { border-left-color: var(--color-urgent); }
        .plant-title { font-weight: 700; margin-bottom: 8px; }
        .plant-source { font-size: 14px; color: var(--text-light-color); margin-bottom: 12px; }
        .plant-status { font-size: 14px; font-weight: 500; }
        .dashboard-modal-content { max-width: 800px; width: 90%; }
        .dashboard-header { margin-bottom: 16px; }
        .dashboard-grid-layout { display: grid; grid-template-columns: 1fr 250px; gap: 24px; }
        .chart-container { position: relative; height: 350px; }
        .empty-message { text-align: center; color: var(--text-light-color); grid-column: 1 / -1; padding: 40px; }

        /* ë©”í‹°ìŠ¤ ì„¸ì…˜ */
        .session-content { max-width: 800px; margin: 0 auto; }
        .session-progress { text-align: center; margin-bottom: 16px; font-size: 18px; color: var(--text-light-color); }
        .goal-display { background-color: var(--background-color); border-left: 4px solid var(--primary-color); padding: 16px; margin-bottom: 24px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s; }
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;}
        .step h4 { font-size: 22px; margin: 0; }
        .step-timer { font-size: 18px; font-weight: 700; color: var(--primary-dark); }
        #timer { font-size: 48px; font-weight: 700; text-align: center; color: var(--primary-dark); margin: 24px 0; }
        #step-break { background-color: #e8f0fe; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .comparison-col h5 { margin-bottom: 8px; color: var(--text-light-color); }
        .comparison-content { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; min-height: 150px; overflow-y: auto; }
        textarea.final-writing { min-height: 250px; }
        
        /* ëª¨ë‹¬, ë¡œë”, í† ìŠ¤íŠ¸ */
        .loader-overlay, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .loader { border: 6px solid rgba(255,255,255,0.3); border-top: 6px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .loader-text { color: white; margin-top: 16px; font-size: 16px; }
        .modal-content { background: var(--surface-color); padding: 32px; border-radius: var(--border-radius); width: 90%; max-width: 700px; animation: fadeIn 0.3s; }
        .modal-controls { margin-top: 24px; display: flex; justify-content: flex-end; gap: 8px; }
        .challenge-title { font-size: 22px; color: var(--primary-dark); margin-bottom: 8px; }
        .challenge-description { color: var(--text-light-color); margin-bottom: 16px; }
        .challenge-prompt { background-color: var(--background-color); border-left: 4px solid var(--primary-color); padding: 16px; margin: 24px 0; border-radius: 4px; font-style: italic; }
        .confidence-rating { margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 16px; }
        #goal-navigator-modal .modal-header { text-align: center; margin-bottom: 24px; }
        .mode-selection-container { display: flex; justify-content: space-around; gap: 20px; }
        .mode-select-btn { flex: 1; padding: 20px; text-align: center; border: 2px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .mode-select-btn:hover { border-color: var(--primary-color); background-color: #E8F0FE; }
        .goal-pack-container { max-height: 40vh; overflow-y: auto; padding: 8px; }
        .goal-card { background: var(--background-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; margin-bottom: 12px; cursor: pointer; }
        .goal-card:hover { border-color: var(--primary-color); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--text-color); color: white; padding: 12px 24px; border-radius: var(--border-radius); z-index: 2000; animation: toast-in 0.5s, toast-out 0.5s 2.5s; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        
        /* ì§€ì  ì—¬ì • ë§µ ìŠ¤íƒ€ì¼ */
        #journey-map-container { position: relative; width: 100%; height: 75vh; background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); overflow: hidden; }
        .journey-node { position: absolute; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; text-align: center; font-size: 14px; padding: 5px; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s; user-select: none; }
        .journey-node:hover { transform: scale(1.1); z-index: 20 !important; }
        .journey-node.book { width: 100px; height: 100px; background-color: var(--primary-dark); z-index: 10; font-weight: 700; }
        .journey-node.plant { width: 70px; height: 70px; font-size: 11px; z-index: 5; }
        #journey-map-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-in { from { bottom: -50px; opacity: 0; } to { bottom: 20px; opacity: 1; } }
        @keyframes toast-out { from { bottom: 20px; opacity: 1; } to { bottom: -50px; opacity: 0; } }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <h1>Project Metis</h1>
            <nav>
                <button class="nav-btn active" data-view="dashboard">
                    <span class="icon">ğŸ </span> ëŒ€ì‹œë³´ë“œ
                </button>
                <button class="nav-btn" data-view="garden">
                    <span class="icon">ğŸŒ¿</span> ì§€ì‹ ì •ì›
                </button>
                <button class="nav-btn" data-view="journey">
                    <span class="icon">ğŸ—ºï¸</span> ì§€ì  ì—¬ì • ë§µ
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <!-- ============== Dashboard View ============== -->
            <div id="dashboard" class="view active">
                <header class="view-header">
                    <h2>ì˜¤ëŠ˜ì˜ ì§€ì‹ íƒí—˜</h2>
                    <p>ë©”ì¸ë¶ì„ ì¤‘ì‹¬ìœ¼ë¡œ ìƒˆë¡œìš´ ì§€ì‹ì„ íƒí—˜í•˜ê³ , ë‹¹ì‹ ì˜ ìì‚°ìœ¼ë¡œ ë§Œë“œì„¸ìš”.</p>
                </header>
                <div class="dashboard-grid">
                    <div id="main-book-slot" class="main-book-slot card">
                        <h3>ğŸ“˜ ë©”ì¸ë¶</h3>
                        <div class="book-info">
                            <img src="https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1593003033l/54495910.jpg" alt="Nudge book cover" class="book-cover">
                            <div class="book-details">
                                <h4>ë„›ì§€ (Nudge)</h4>
                                <p>ë¦¬ì²˜ë“œ H. íƒˆëŸ¬, ìºìŠ¤ R. ì„ ìŠ¤íƒ€ì¸</p>
                                <div id="main-book-goal" class="goal">
                                    <strong>ğŸ¯ í˜„ì¬ ëª©í‘œ (ë ˆë²¨ 2)</strong>
                                    <p>ì„ íƒ ì„¤ê³„ì˜ 3ìš”ì†Œ(ë””í´íŠ¸, í”¼ë“œë°±, ì˜¤ë¥˜ ì˜ˆìƒ)ë¥¼ ì„¤ëª…í•˜ê³ , ì‹¤ìƒí™œ ì‚¬ë¡€ 1ê°€ì§€ì”© ì°¾ì•„ë³´ê¸°.</p>
                                </div>
                            </div>
                        </div>
                        <div class="course-selection">
                            <h5>í•™ìŠµ ì½”ìŠ¤ ì„ íƒ</h5>
                            <div class="course-buttons">
                                <button class="course-btn btn active" data-duration="30">30ë¶„ ì½”ìŠ¤</button>
                                <button class="course-btn btn" data-duration="60">60ë¶„ ì½”ìŠ¤</button>
                                <button class="course-btn btn" data-duration="90">90ë¶„ ì½”ìŠ¤</button>
                                <button class="course-btn btn" data-duration="120">120ë¶„ ì½”ìŠ¤</button>
                            </div>
                        </div>
                        <button id="start-session-btn" class="btn btn-primary" style="margin-top: 16px;">ìƒˆë¡œìš´ ì§€ì‹ íƒí—˜í•˜ê¸° (ë©”í‹°ìŠ¤ ì„¸ì…˜)</button>
                    </div>
                    <div class="ai-assistant-slot card">
                        <h3>ğŸ¤– AI ëª©í‘œ ë‚´ë¹„ê²Œì´í„°</h3>
                        <p>ì±…ì„ í†µí•´ ë¬´ì—‡ì„ ì–»ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? AIê°€ ìµœì ì˜ í•™ìŠµ ëª©í‘œ ì„¤ì •ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.</p>
                        <div class="book-title-input">
                            <label for="book-title-for-goal">ëŒ€ìƒ ë„ì„œ:</label>
                            <input type="text" id="book-title-for-goal" value="ë„›ì§€ (Nudge)" placeholder="ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <button id="start-goal-navigator-btn" class="btn">AI ëª©í‘œ ì„¤ì • ì‹œì‘í•˜ê¸°</button>
                    </div>
                    <div class="sub-book-shelf-container card">
                        <h3>ğŸ“š ê´€ì‹¬ ì„œì¬ (ì„œë¸Œë¶)</h3>
                        <div class="sub-book-shelf">
                            <img src="https://image.aladin.co.kr/product/30883/29/cover500/k252830635_1.jpg" alt="Book cover 1" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/10/3/cover500/8932917248_2.jpg" alt="Book cover 2" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/33359/29/cover500/k252938250_1.jpg" alt="Book cover 3" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/1324/3/cover500/890120935x_1.jpg" alt="Book cover 4" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/29306/17/cover500/s972837389_1.jpg" alt="Book cover 5" class="sub-book-cover">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ============== Knowledge Garden View ============== -->
            <div id="garden" class="view">
                <header class="view-header">
                    <h2>ğŸŒ¿ ì§€ì‹ ì •ì›</h2>
                    <p>ë‹¹ì‹ ì˜ ëª¨ë“  ì§€ì‹ ìì‚°(ì‹ë¬¼)ì´ ìë¼ê³  ìˆìŠµë‹ˆë‹¤. ìƒíƒœë¥¼ ë³´ê³  ê´€ë¦¬í•´ì£¼ì„¸ìš”.</p>
                </header>
                <div class="garden-container" id="garden-container">
                    <!-- Knowledge plants will be rendered here -->
                </div>
            </div>

            <!-- ============== Journey Map View ============== -->
            <div id="journey" class="view">
                <header class="view-header">
                    <h2>ğŸ—ºï¸ ì§€ì  ì—¬ì • ë§µ</h2>
                    <p>ë‹¹ì‹ ì˜ ì§€ì‹ë“¤ì´ ì–´ë–»ê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ íƒí—˜í•˜ì„¸ìš”.</p>
                </header>
                <div id="journey-map-container">
                    <svg id="journey-map-svg"></svg>
                    <!-- Nodes will be rendered here via JS -->
                </div>
            </div>

            <!-- ============== Metis Session View ============== -->
            <div id="metis-session" class="view">
                 <header class="view-header">
                     <button id="back-to-dashboard-btn" class="btn btn-secondary">â† ë’¤ë¡œê°€ê¸°</button>
                     <h2>ğŸ§  ë©”í‹°ìŠ¤ í•™ìŠµ ì„¸ì…˜</h2>
                     <p id="step-title">ë‹¨ê³„ 1: í•™ìŠµ ì˜ˆì¸¡</p>
                 </header>
                 <div class="session-content">
                    <div class="session-progress" id="session-progress"></div>
                     <!-- Step 1: Prediction -->
                     <div id="step-1" class="step active card">
                        <div class="step-header">
                            <h4>[1/7] í•™ìŠµ ì˜ˆì¸¡ (Prediction)</h4>
                            <div class="step-timer" id="timer-step-1">05:00</div>
                        </div>
                        <p>5ë¶„ ì•ˆì—, ìœ„ ëª©í‘œì™€ ê´€ë ¨í•˜ì—¬ ì±…ì—ì„œ ì–´ë–¤ ë‚´ìš©ì„ ë‹¤ë£° ê²ƒ ê°™ìŠµë‹ˆê¹Œ? í•µì‹¬ ë‚´ìš©ì„ ì˜ˆì¸¡í•´ë³´ì„¸ìš”.</p>
                        <textarea id="prediction-input" placeholder="ì˜ˆ: ë„›ì§€ì˜ ê°œë…ì„ ì„¤ëª…í•˜ê³ , ì‚¬ëŒë“¤ì˜ ë¹„í•©ë¦¬ì  ì„ íƒì„ ìœ ë„í•˜ëŠ” ì‚¬ë¡€ë¥¼ ë³´ì—¬ì¤„ ê²ƒ ê°™ë‹¤."></textarea>
                        <button class="btn btn-primary next-step-btn">ì˜ˆì¸¡ ì™„ë£Œ, ì§‘ì¤‘ ë…ì„œ ì‹œì‘</button>
                    </div>
                    <!-- Step 2: Reading -->
                     <div id="step-2" class="step card">
                         <h4>[2/7] ì§‘ì¤‘ ë…ì„œ (Focused Reading)</h4>
                         <p>ì´ì œ 25ë¶„ê°„ ëª©í‘œì—ë§Œ ì§‘ì¤‘í•˜ì—¬ ì±…ì„ ì½ìŠµë‹ˆë‹¤. ëª°ì…ì„ ìœ„í•´ ë°©í•´ ìš”ì†Œë¥¼ ì œê±°í•˜ì„¸ìš”.</p>
                         <div id="timer">25:00</div>
                         <button class="btn btn-primary" id="finish-reading-btn">ë…ì„œ ì™„ë£Œ</button>
                     </div>
                    <!-- Break Step -->
                    <div id="step-break" class="step card">
                        <h4>â˜•ï¸ 5ë¶„ íœ´ì‹ (Active Break)</h4>
                        <p>ì ì‹œ íœ´ì‹ì„ ì·¨í•˜ë©° ë‡Œë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤. ì•„ë˜ ì§ˆë¬¸ì— ëŒ€í•´ ê°€ë³ê²Œ ìƒê°í•´ë³´ì„¸ìš”.</p>
                        <div id="timer-break">05:00</div>
                        <div class="card">
                            <h5>ì¤‘ê°„ ì˜ˆì¸¡ ì ê²€</h5>
                            <p>ì§€ê¸ˆê¹Œì§€ ì½ì€ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, ì²˜ìŒì˜ ì˜ˆì¸¡ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ë³´ì™„í•˜ê³  ì‹¶ì€ ë¶€ë¶„ì´ ìˆë‚˜ìš”?</p>
                        </div>
                        <button class="btn btn-primary" id="start-next-cycle-btn">íœ´ì‹ ì™„ë£Œ, ë‹¤ìŒ ì„¸ì…˜ ì‹œì‘</button>
                    </div>
                    <!-- Step 3: Brain Dump -->
                     <div id="step-3" class="step card">
                        <div class="step-header">
                            <h4>[3/7] ìƒê° ê¸°ë¡ (Brain Dump)</h4>
                            <div class="step-timer" id="timer-step-3">05:00</div>
                        </div>
                        <p>5ë¶„ ì•ˆì—, ë°©ê¸ˆ ì½ì€ ë‚´ìš©ê³¼ ê·¸ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ìƒê°ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ì„¸ìš”.</p>
                        <textarea id="braindump-input" placeholder="ì •ë¦¬ë˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤. ë– ì˜¤ë¥´ëŠ” ëª¨ë“  ê²ƒì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                        <button class="btn btn-primary next-step-btn">ê¸°ë¡ ì™„ë£Œ</button>
                    </div>
                    <!-- Step 4: AI Prediction -->
                     <div id="step-4" class="step card">
                        <div class="step-header">
                            <h4>[4/7] AI í”¼ë“œë°± ì˜ˆì¸¡ (Metacognition)</h4>
                            <div class="step-timer" id="timer-step-4">05:00</div>
                        </div>
                        <p>5ë¶„ ì•ˆì—, AIê°€ ë‹¹ì‹ ì˜ ê¸°ë¡ì— ëŒ€í•´ ì–´ë–¤ í”¼ë“œë°±ì„ ì¤„ ê²ƒ ê°™ìŠµë‹ˆê¹Œ? ë‹¹ì‹ ì´ ë†“ì¹œ ë¶€ë¶„ì€ ë¬´ì—‡ì¼ê¹Œìš”?</p>
                        <textarea id="ai-prediction-input" placeholder="ì˜ˆ: ê°œë… ì„¤ëª…ì€ ì˜í–ˆì§€ë§Œ, ê° ìš”ì†Œê°€ ì–´ë–»ê²Œ ìƒí˜¸ì‘ìš©í•˜ëŠ”ì§€ì— ëŒ€í•œ ì„¤ëª…ì´ ë¶€ì¡±í•˜ë‹¤ê³  ì§€ì í•  ê²ƒ ê°™ë‹¤."></textarea>
                        <button class="btn btn-primary next-step-btn">ì˜ˆì¸¡ ì™„ë£Œ</button>
                    </div>
                    <!-- Step 5: Reveal -->
                    <div id="step-5" class="step card">
                        <div class="step-header">
                            <h4>[5/7] ë¹„êµ ë¶„ì„ (The Reveal)</h4>
                        </div>
                        <p>ìì‹ ì˜ ì´í•´ë„ì™€ ì‹¤ì œ ì´í•´ë„ ì‚¬ì´ì˜ ê²©ì°¨(Gap)ë¥¼ ê°ê´€ì ìœ¼ë¡œ ì¸ì§€í•˜ì„¸ìš”.</p>
                        <div class="comparison-grid">
                            <div class="comparison-col"><h5>ğŸ¤” ë‚´ ìƒê°</h5><div id="reveal-my-thoughts" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5>ğŸ¤– AI í”¼ë“œë°±</h5><div id="reveal-ai-feedback" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5>ğŸ”® ë‚´ ì˜ˆì¸¡</h5><div id="reveal-my-prediction" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5> A ì „ë¬¸ê°€ ìš”ì•½</h5><div id="reveal-expert-summary" class="comparison-content"></div></div>
                        </div>
                        <button class="btn btn-primary next-step-btn">ë¶„ì„ ì™„ë£Œ</button>
                    </div>
                    <!-- Step 6: Gap Extraction -->
                     <div id="step-6" class="step card">
                        <div class="step-header">
                            <h4>[6/7] ê¸€ì“°ê¸°ë¥¼ ìœ„í•œ í•µì‹¬ ì§ˆë¬¸ ì¶”ì¶œ</h4>
                            <div class="step-timer" id="timer-step-6">05:00</div>
                        </div>
                        <p>5ë¶„ ì•ˆì—, ë‹¹ì‹ ì˜ ìƒê°ê³¼ AIì˜ ë¶„ì„ ì‚¬ì´ì—ì„œ ë°œê²¬í•œ 'ê²©ì°¨(Gap)'ë¥¼ í•´ì†Œí•  í•µì‹¬ ì§ˆë¬¸ í•˜ë‚˜ë¥¼ ë½‘ì•„ë³´ì„¸ìš”.</p>
                        <textarea id="gap-input" placeholder="ì˜ˆ: ë‚˜ëŠ” ê°œë…ì˜ ë‚˜ì—´ì— ê·¸ì³¤ì§€ë§Œ, AIëŠ” 'ê°œë… ê°„ì˜ ì—°ê²°ì„± ë¶€ì¡±'ì„ ì§€ì í–ˆë‹¤. ê·¸ë ‡ë‹¤ë©´, ê° ê°œë…ë“¤ì€ ì–´ë–»ê²Œ ìœ ê¸°ì ìœ¼ë¡œ ì—°ê²°ë˜ëŠ”ê°€?"></textarea>
                        <button class="btn btn-primary next-step-btn">ì§ˆë¬¸ ì¶”ì¶œ ì™„ë£Œ</button>
                    </div>
                    <!-- Step 7: Final Writing -->
                     <div id="step-7" class="step card">
                        <div class="step-header">
                             <h4>[7/7] ì™„ë²½í•œ ì²´í™”ë¥¼ ìœ„í•œ ê¸€ì“°ê¸°</h4>
                             <div class="step-timer" id="timer-step-7">05:00</div>
                        </div>
                         <p>5ë¶„ ì•ˆì—, ë°©ê¸ˆ ì¶”ì¶œí•œ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì„ ìŠ¤ìŠ¤ë¡œ ì„¤ëª…í•˜ëŠ” í•œ í¸ì˜ ê¸€ì„ ì™„ì„±í•˜ì„¸ìš”.</p>
                         <textarea id="final-writing-input" class="final-writing" placeholder="6ë‹¨ê³„ì—ì„œ ë½‘ì•„ë‚¸ ì§ˆë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ, ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©ì„ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì„¤ëª…í•˜ë“¯ ììœ ë¡­ê²Œ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”."></textarea>
                         <button id="finish-session-btn" class="btn btn-primary">ê¸€ì“°ê¸° ì™„ë£Œ, ì§€ì‹ ì •ì›ì— ì”¨ì•— ì‹¬ê¸°</button>
                     </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- ============== Modals ============== -->
    <div id="loader" class="loader-overlay"><div class="loader"></div><div class="loader-text">AIê°€ ë‹¹ì‹ ì˜ ìƒê°ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div></div>
    <div id="challenge-modal-overlay" class="modal-overlay"><div id="challenge-modal" class="modal-content"></div></div>
    <div id="goal-navigator-modal-overlay" class="modal-overlay"><div id="goal-navigator-modal" class="modal-content"><div id="goal-navigator-content"></div></div></div>
    <!-- ê¸°ì–µ ê³¡ì„  ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬ -->
    <div id="dashboard-modal-overlay" class="modal-overlay">
        <div id="dashboard-modal" class="modal-content dashboard-modal-content">
            <div class="dashboard-header">
                <h3 id="dashboard-title">ê¸°ì–µ ê³¡ì„  ëŒ€ì‹œë³´ë“œ</h3>
                <p id="dashboard-source"></p>
            </div>
            <div class="dashboard-grid-layout">
                <div class="chart-container">
                    <canvas id="memoryCurveChart"></canvas>
                </div>
                <div class="analysis-panel">
                    <h4>ìƒíƒœ ë¶„ì„</h4>
                    <p id="dashboard-status-analysis"></p>
                    <hr style="margin: 16px 0;">
                    <h4>ì‹œë®¬ë ˆì´ì…˜</h4>
                    <p>ì§€ê¸ˆ ë³µìŠµí•˜ë©´ ë¯¸ë˜ì˜ ê¸°ì–µ ê³¡ì„ ì´ ì–´ë–»ê²Œ ë³€í• ê¹Œìš”?</p>
                    <button id="simulate-review-btn" class="btn btn-primary" style="width: 100%; margin-top: 8px;">ì˜¤ëŠ˜ ë³µìŠµ ì‹œë®¬ë ˆì´ì…˜</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =================================================================================
        // UI Module: Handles all DOM manipulations and rendering
        // =================================================================================
        const UI = {
            switchView(viewName, navButtons) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewName)?.classList.add('active'); navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName)); },
            switchStep(step) { 
                document.querySelectorAll('#metis-session .step').forEach(s => s.classList.remove('active')); 
                const el = document.getElementById(step);
                if (el) { 
                    el.classList.add('active'); 
                    const titleEl = el.querySelector('h4');
                    if (titleEl) document.getElementById('step-title').textContent = titleEl.textContent; 
                } 
            },
            updateTimer(timeLeft, elementId) { const min = Math.floor(timeLeft / 60), sec = timeLeft % 60; const timerEl = document.getElementById(elementId); if (timerEl) timerEl.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; },
            updateProgress(progress) { const el = document.getElementById('session-progress'); if (el) el.innerHTML = progress;},
            showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; },
            showToast(message, type = 'info') { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); },
            showConfirm(msg, onConfirm) { const ov = document.createElement('div'); ov.className = 'modal-overlay'; ov.style.display = 'flex'; const md = document.createElement('div'); md.className = 'modal-content'; md.innerHTML = `<p>${msg}</p><div class="modal-controls"><button id="c-cancel" class="btn">ì·¨ì†Œ</button><button id="c-ok" class="btn btn-primary">í™•ì¸</button></div>`; ov.appendChild(md); document.body.appendChild(ov); ov.onclick = e => { if (e.target.id === 'c-ok') onConfirm(); if (e.target.closest('#c-cancel') || e.target.closest('#c-ok') || e.target === ov) ov.remove(); }; },
            GoalNavigator: { overlay: document.getElementById('goal-navigator-modal-overlay'), content: document.getElementById('goal-navigator-content'), show() { this.overlay.style.display = 'flex'; }, hide() { this.overlay.style.display = 'none'; }, render(step, data) { let html = ''; switch (step) { case 'modeSelection': html = `<div class="modal-header"><h3>AI ëª©í‘œ ë‚´ë¹„ê²Œì´í„°</h3><p><strong>${data.bookTitle}</strong> í•™ìŠµ ëª©í‘œ ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p></div><div class="mode-selection-container"><div class="mode-select-btn" data-mode="explorer"><h4>ğŸ§­ íƒí—˜ê°€ ëª¨ë“œ</h4><p>AI ìƒì„± ëª©í‘œ íŒ©ì—ì„œ ì„ íƒ</p></div><div class="mode-select-btn" data-mode="solver"><h4>ğŸ› ï¸ í•´ê²°ì‚¬ ëª¨ë“œ</h4><p>ë¬¸ì œ ì…ë ¥, ë§ì¶¤í˜• ëª©í‘œ ìƒì„±</p></div></div>`; break; case 'explorer': html = `<div class="modal-header"><h3>ğŸ§­ íƒí—˜ê°€ ëª¨ë“œ</h3><p>ê°€ì¥ ë§ˆìŒì— ë“œëŠ” ëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p></div><div class="goal-pack-container">${data.goalPack.map(g => `<div class="goal-card" data-level="${g.level}" data-text="${g.text}"><strong>[ë ˆë²¨ ${g.level}]</strong> ${g.text}</div>`).join('')}</div>`; break; case 'solver': html = `<div class="modal-header"><h3>ğŸ› ï¸ í•´ê²°ì‚¬ ëª¨ë“œ</h3><p>ì´ ì±…ìœ¼ë¡œ í•´ê²°í•˜ê³  ì‹¶ì€ ë¬¸ì œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</p></div><div><textarea id="solver-problem-input" placeholder="ì˜ˆ: ë©´ì ‘ê´€ì˜ ì˜ë„ë¥¼ íŒŒì•…í•˜ê³  ì‹¶ì–´ìš”."></textarea></div><div class="modal-controls"><button id="solver-submit-problem" class="btn btn-primary">ëª©í‘œ ìƒì„±</button></div>`; break; case 'architect': html = `<div class="modal-header"><h3>âœ… ëª©í‘œ í™•ì •</h3><p>AI ì œì•ˆ ëª©í‘œë¥¼ ìˆ˜ì •í•˜ì—¬ í™•ì •í•˜ì„¸ìš”.</p></div><div><textarea id="architect-goal-editor">${data.text}</textarea></div><div class="modal-controls"><button id="architect-confirm-goal" class="btn btn-primary">ë©”ì¸ ëª©í‘œë¡œ ì„¤ì •</button></div>`; break; } this.content.innerHTML = html; } },
            renderGarden(plants) {
                const container = document.getElementById('garden-container');
                container.innerHTML = '';
                if (plants.length === 0) {
                    container.innerHTML = `<p class="empty-message">ì•„ì§ ì •ì›ì— ì‹ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë©”í‹°ìŠ¤ ì„¸ì…˜ì„ í†µí•´ ì²« ì”¨ì•—ì„ ì‹¬ì–´ë³´ì„¸ìš”!</p>`;
                    return;
                }
                plants.sort((a,b) => a.daysUntilReview - b.daysUntilReview).forEach(plant => {
                    const el = document.createElement('div');
                    el.className = `plant-card ${plant.status}`;
                    el.dataset.id = plant.id;
                    const reviewText = plant.daysUntilReview > 0 ? `ë³µìŠµê¹Œì§€ ${plant.daysUntilReview}ì¼` : 'ì˜¤ëŠ˜ ë³µìŠµ!';
                    el.innerHTML = `<div class="plant-title">${plant.title}</div><div class="plant-source">${plant.sourceBook}</div><div class="plant-status">${reviewText}</div>`;
                    container.appendChild(el);
                });
            },
            Dashboard: {
                overlay: document.getElementById('dashboard-modal-overlay'),
                title: document.getElementById('dashboard-title'),
                source: document.getElementById('dashboard-source'),
                status: document.getElementById('dashboard-status-analysis'),
                chartCanvas: document.getElementById('memoryCurveChart'),
                chart: null,
                show(plant, chartData) {
                    this.title.textContent = `"${plant.title}" ê¸°ì–µ ê³¡ì„ `;
                    this.source.textContent = `ì¶œì²˜: ${plant.sourceBook}`;
                    this.status.textContent = `í˜„ì¬ ì´ ì§€ì‹ì€ '${plant.memoryStage}' ìƒíƒœì…ë‹ˆë‹¤. ê¸°ì–µ ê°•ë„ëŠ” ${plant.strength}ì…ë‹ˆë‹¤.`;
                    
                    document.getElementById('simulate-review-btn').disabled = false;
                    document.getElementById('simulate-review-btn').textContent = 'ì˜¤ëŠ˜ ë³µìŠµ ì‹œë®¬ë ˆì´ì…˜';

                    if (this.chart) this.chart.destroy();
                    this.chart = new Chart(this.chartCanvas, chartData);
                    
                    this.overlay.style.display = 'flex';
                },
                hide() { this.overlay.style.display = 'none'; },
                updateChart(newData) {
                    if (!this.chart) return;
                    const existingSimIndex = this.chart.data.datasets.findIndex(d => d.label.includes('ì‹œë®¬ë ˆì´ì…˜'));
                    if(existingSimIndex > -1) this.chart.data.datasets.splice(existingSimIndex, 1);
                    this.chart.data.datasets.push(newData);
                    this.chart.update();
                }
            },
            Challenge: {
                overlay: document.getElementById('challenge-modal-overlay'),
                content: document.getElementById('challenge-modal'),
                show(challenge, onComplete) {
                    let challengeHTML = '';
                    switch (challenge.type) {
                        case 'connect':
                            challengeHTML = `<h3 class="challenge-title">ì±Œë¦°ì§€ Lv.2: ì‚¬ë¡€ ì—°ê²°</h3> <p class="challenge-description">ì´ ì§€ì‹ì„ ì„¤ëª…í•  ìˆ˜ ìˆëŠ” ìµœê·¼ ë‰´ìŠ¤ ê¸°ì‚¬ë‚˜ ë‹¹ì‹ ì˜ ê°œì¸ì ì¸ ê²½í—˜ í•œ ê°€ì§€ë¥¼ ì œì‹œí•˜ì„¸ìš”.</p>`;
                            break;
                        case 'critique':
                            challengeHTML = `<h3 class="challenge-title">ì±Œë¦°ì§€ Lv.3: ë¹„íŒì  ì‚¬ê³ </h3> <p class="challenge-description">ì´ ì§€ì‹ì˜ í•œê³„ì ì´ë‚˜ ì ì¬ì ì¸ ë°˜ë¡ ì€ ë¬´ì—‡ì¼ê¹Œìš”?</p>`;
                            break;
                        default:
                            challengeHTML = `<h3 class="challenge-title">ì±Œë¦°ì§€ Lv.1: í•µì‹¬ ë‚´ìš© ì¸ì¶œ</h3> <p class="challenge-description">"${challenge.sourceBook}"ì—ì„œ ë°°ìš´ ë‚´ìš©ì„ ë– ì˜¬ë ¤ë³´ì„¸ìš”.</p>`;
                            break;
                    }
                    this.content.innerHTML = `${challengeHTML}
                        <div class="challenge-prompt">${challenge.question.replace(/\n/g, '<br>')}</div>
                        <textarea id="challenge-answer" placeholder="ë‹¹ì‹ ì˜ ì–¸ì–´ë¡œ ììœ ë¡­ê²Œ ì„¤ëª…í•´ë³´ì„¸ìš”..."></textarea>
                        <div class="confidence-rating"><p>ì´ë²ˆ ë‹µë³€ì— ì–¼ë§ˆë‚˜ í™•ì‹ í–ˆë‚˜ìš”?</p><div class="confidence-buttons"><button class="btn" data-confidence="confident">âœ… í™•ì‹ í•¨</button><button class="btn" data-confidence="unsure">ğŸ¤” ê¸´ê°€ë¯¼ê°€í•¨</button><button class="btn" data-confidence="guess">â“ ê±°ì˜ ì¶”ì¸¡í•¨</button></div></div>
                        <div class="modal-controls"><button id="challenge-cancel-btn" class="btn">ì·¨ì†Œ</button><button id="challenge-submit-btn" class="btn btn-primary" disabled>ë³µìŠµ ì™„ë£Œ</button></div>`;
                    this.overlay.style.display = 'flex';
                    let selectedConfidence = null;
                    const clickHandler = (e) => {
                        const target = e.target;
                        if(target.closest('.confidence-buttons .btn')){
                            this.content.querySelectorAll('.confidence-buttons .btn').forEach(b => b.classList.remove('active'));
                            target.closest('.btn').classList.add('active');
                            selectedConfidence = target.closest('.btn').dataset.confidence;
                            this.content.querySelector('#challenge-submit-btn').disabled = false;
                        } else if (target.id === 'challenge-cancel-btn' || target.id === 'challenge-submit-btn'){
                            if (target.id === 'challenge-submit-btn' && selectedConfidence) onComplete(selectedConfidence);
                            this.hide(clickHandler);
                        }
                    };
                    this.content.addEventListener('click', clickHandler);
                },
                hide(handler) { if(this.overlay) this.overlay.style.display = 'none'; if (handler) this.content.removeEventListener('click', handler); }
            }
        };

        // =================================================================================
        // MetisSession Module: Handles the 7-step learning cycle
        // =================================================================================
        const MetisSession = {
            state: {}, 
            writingSteps: ['step-1', 'step-3', 'step-4', 'step-6', 'step-7'],
            stepSequence: ['step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-6', 'step-7'],

            initialState: { 
                currentStepId: 'step-1', 
                userInputs: { prediction: '', brainDump: '', aiPrediction: '', gap: '', finalWriting: '' }, 
                timerInterval: null, 
                sourceBook: '', 
                initialGoal: '',
                totalDuration: 30,
                focusDuration: 25 * 60,
                breakDuration: 5 * 60,
                writingDuration: 5 * 60,
                timeLeft: 0,
                cyclesTotal: 1,
                cyclesCompleted: 0,
                currentPhase: 'writing', // writing, focus, break
            },
            
            init() { 
                this.reset();
                this.state.sourceBook = document.querySelector('#main-book-slot h4').textContent; 
                this.state.initialGoal = document.querySelector('#main-book-goal p').textContent; 
                
                const selectedCourse = document.querySelector('.course-btn.active');
                this.state.totalDuration = selectedCourse ? parseInt(selectedCourse.dataset.duration, 10) : 30;
                
                this.state.cyclesTotal = Math.floor(this.state.totalDuration / 30) * 2 - (this.state.totalDuration % 30 === 0 ? 1 : 0);
                if (this.state.totalDuration < 30) this.state.cyclesTotal = 1;
                
                document.getElementById('session-goal-display').innerHTML = document.getElementById('main-book-goal').innerHTML; 
                this.handleStepLogic(this.state.currentStepId);
            },
            
            reset() { 
                clearInterval(this.state.timerInterval); 
                this.state = JSON.parse(JSON.stringify(this.initialState)); 
            },

            startTimer(duration, elementId, onComplete) {
                if (this.state.timerInterval) clearInterval(this.state.timerInterval);
                this.state.timeLeft = duration;
                UI.updateTimer(this.state.timeLeft, elementId);

                this.state.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    UI.updateTimer(this.state.timeLeft, elementId);
                    if (this.state.timeLeft <= 0) {
                        clearInterval(this.state.timerInterval);
                        onComplete();
                    }
                }, 1000);
            },
            
            handleStepLogic(stepId) {
                this.state.currentStepId = stepId;
                UI.switchStep(stepId);
                clearInterval(this.state.timerInterval);
                
                if (this.writingSteps.includes(stepId)) {
                    this.state.currentPhase = 'writing';
                    const timerId = `timer-${stepId}`;
                    this.startTimer(this.state.writingDuration, timerId, () => this.proceed());
                } else if (stepId === 'step-2') {
                    this.state.currentPhase = 'focus';
                    UI.updateProgress(this.generateProgressHTML());
                    this.startTimer(this.state.focusDuration, 'timer', () => this.handleFocusEnd());
                } else if (stepId === 'step-break') {
                    this.state.currentPhase = 'break';
                    this.startTimer(this.state.breakDuration, 'timer-break', () => this.handleBreakEnd());
                }
            },

            proceed() {
                const currentId = this.state.currentStepId;
                
                // Save input if it's a writing step
                if (this.writingSteps.includes(currentId)) {
                    const inputId = `${currentId.split('-')[1]}-input`;
                    const inputEl = document.getElementById(inputId);
                    if(inputEl) {
                        const key = inputId.replace('-input', '').replace('prediction', 'prediction').replace('braindump', 'brainDump').replace('aiPrediction', 'aiPrediction').replace('gap', 'gap').replace('finalWriting', 'finalWriting');
                         if(this.state.userInputs.hasOwnProperty(key)) {
                             this.state.userInputs[key] = inputEl.value;
                         }
                    }
                }

                const currentIndex = this.stepSequence.indexOf(currentId);
                if (currentIndex < this.stepSequence.length - 1) {
                    const nextStepId = this.stepSequence[currentIndex + 1];
                    this.handleStepLogic(nextStepId);
                }
            },

            async handleFocusEnd() {
                this.state.cyclesCompleted++;
                if (this.state.cyclesCompleted < this.state.cyclesTotal) {
                    this.handleStepLogic('step-break');
                } else {
                    UI.showToast("ëª¨ë“  ì§‘ì¤‘ ì„¸ì…˜ ì™„ë£Œ! ìƒê°ì„ ê¸°ë¡í•˜ì„¸ìš”.", "success");
                    this.handleStepLogic('step-3');
                }
            },

            handleBreakEnd() {
                UI.showToast("íœ´ì‹ ì¢…ë£Œ! ë‹¤ìŒ ì„¸ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.", "success");
                this.handleStepLogic('step-2');
            },

            generateProgressHTML(){
                let html = '';
                for(let i = 0; i < this.state.cyclesTotal; i++){
                    html += (i < this.state.cyclesCompleted) ? 'âœ…' : 'ğŸ…';
                    if(i < this.state.cyclesTotal - 1) html += ' â˜•ï¸ ';
                }
                return `Cycle ${this.state.cyclesCompleted + 1} / ${this.state.cyclesTotal} <br> ${html}`;
            },
            
            async completeSessionFlow() {
                UI.showLoader(true);
                const { brainDump, aiPrediction } = this.state.userInputs;
                const [feedback, summary] = await Promise.all([this.getAIFeedback(brainDump), this.getExpertSummary()]);
                document.getElementById('reveal-my-thoughts').textContent = brainDump || " ";
                document.getElementById('reveal-ai-feedback').textContent = feedback;
                document.getElementById('reveal-my-prediction').textContent = aiPrediction || " ";
                document.getElementById('reveal-expert-summary').textContent = summary;
                UI.showLoader(false);
                this.handleStepLogic('step-6');
            },

            complete() { 
                this.state.userInputs.finalWriting = document.getElementById('final-writing-input').value; 
                if (!this.state.userInputs.finalWriting.trim()) { 
                    UI.showToast('ì²´í™” ê¸€ì“°ê¸°ë¥¼ ì‘ì„±í•´ì•¼ ìº¡ìŠì„ ë´‰ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error'); return; 
                } 
                document.dispatchEvent(new CustomEvent('sessionComplete', { detail: { finished: true, data: this.state } })); 
            },

            simulateApi: (data, delay = 1000) => new Promise(res => setTimeout(() => res(data), delay)),
            getAIFeedback(text) { return this.simulateApi(`ì‚¬ìš©ìì˜ ê¸°ë¡ì„ ë¶„ì„í•œ ê²°ê³¼, í•µì‹¬ ê°œë…ì€ íŒŒì•…í–ˆìœ¼ë‚˜ ê° ìš”ì†Œ ê°„ì˜ ìœ ê¸°ì  'ì—°ê²°ì„±'ì— ëŒ€í•œ ì„¤ëª…ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.`); },
            getExpertSummary() { return this.simulateApi(`**ë„›ì§€(Nudge):** ì¸ê°„ì€ ì²´ê³„ì ìœ¼ë¡œ í¸í–¥ë˜ì–´ ìˆìœ¼ë©°, 'ì„ íƒ ì„¤ê³„'ë¥¼ í†µí•´ ë” ë‚˜ì€ ê²°ì •ì„ ë‚´ë¦¬ë„ë¡ ë¶€ë“œëŸ½ê²Œ ê°œì…í•  ìˆ˜ ìˆë‹¤.`); }
        };

        // =================================================================================
        // Ebbinghaus Module: Manages knowledge plants, reviews, and journey map
        // =================================================================================
        const Ebbinghaus = {
            plants: [],
            getReviewInterval(strength) { if (strength <= 1) return 1; if (strength === 2) return 3; if (strength === 3) return 7; return Math.round(this.getReviewInterval(strength - 1) * 2.1); },
            load() { this.plants = JSON.parse(localStorage.getItem('knowledgePlants')) || []; this.plants.forEach(p => this.updatePlantState(p)); },
            updatePlantState(plant) { const now = new Date(); now.setHours(0, 0, 0, 0); const lastReviewed = new Date(plant.reviews[plant.reviews.length - 1].date); const interval = this.getReviewInterval(plant.strength); const nextReviewDate = new Date(lastReviewed); nextReviewDate.setDate(lastReviewed.getDate() + interval); nextReviewDate.setHours(0,0,0,0); plant.nextReviewDate = nextReviewDate; const diffDays = Math.ceil((nextReviewDate - now) / (1000 * 60 * 60 * 24)); plant.daysUntilReview = Math.max(0, diffDays); if (diffDays <= 0) plant.status = 'urgent'; else if (diffDays <= 3) plant.status = 'needs-care'; else plant.status = 'healthy'; if (plant.strength <= 2) plant.memoryStage = 'ë‹¨ê¸° ê¸°ì–µ'; else if (plant.strength <= 4) plant.memoryStage = 'ì¥ê¸° ê¸°ì–µ ì „í™˜ ì¤‘'; else plant.memoryStage = 'ì¥ê¸° ê¸°ì–µ'; },
            plantSeed(sessionData) { const { initialGoal, sourceBook, finalWriting, gap } = sessionData.userInputs; const newPlant = { id: Date.now(), title: initialGoal.substring(0, 40) + '...', sourceBook, question: `[í•µì‹¬ ì§ˆë¬¸] ${gap}\n\nìœ„ ì§ˆë¬¸ì— ëŒ€í•´ ë‹¹ì‹ ì´ ì²´í™”í•œ ì§€ì‹ì„ ì„¤ëª…í•˜ì„¸ìš”.`, answer: finalWriting, strength: 1, reviews: [{ date: new Date().toISOString() }] }; if (!this.plants.some(p => p.question.includes(gap))) { this.plants.push(newPlant); localStorage.setItem('knowledgePlants', JSON.stringify(this.plants)); UI.showToast("ì§€ì‹ ì •ì›ì— ìƒˆë¡œìš´ ì”¨ì•—ì„ ì‹¬ì—ˆìŠµë‹ˆë‹¤!", "success"); } else UI.showToast("ì´ë¯¸ ë™ì¼í•œ ì§ˆë¬¸ì˜ ì”¨ì•—ì´ ì¡´ì¬í•©ë‹ˆë‹¤.", "error"); },
            initGarden() { this.load(); UI.renderGarden(this.plants); },
            getPlantById(id) { return this.plants.find(p => p.id == id); },
            startReview(plantId){
                const plant = this.getPlantById(plantId);
                if(!plant) return;
                let challengeType = 'recall';
                if(plant.strength >= 5) challengeType = 'critique';
                else if (plant.strength >= 3) challengeType = 'connect';
                const challenge = { type: challengeType, question: plant.question, sourceBook: plant.sourceBook };
                UI.Challenge.show(challenge, (confidence) => {
                    plant.reviews.push({ date: new Date().toISOString(), confidence });
                    if(confidence === 'confident') plant.strength += 1;
                    else if(confidence === 'guess') plant.strength = Math.max(1, plant.strength - 1);
                    localStorage.setItem('knowledgePlants', JSON.stringify(this.plants));
                    this.initGarden();
                    UI.showToast('ë³µìŠµ ì™„ë£Œ! ì§€ì‹ì˜ í˜ì´ ê°•í•´ì¡ŒìŠµë‹ˆë‹¤.', 'success');
                });
            },
            generateCurveData(startDate, strength, days = 30) { const data = []; const decay = 0.3 / Math.log(strength + 1.5); for (let i = 0; i <= days; i++) { const d = new Date(startDate); d.setDate(d.getDate() + i); const retention = 100 * Math.exp(-i * decay); data.push({ x: d, y: retention }); } return data; },
            createChartConfig(plant) {
                const datasets = [{
                    label: 'í˜„ì¬ ë§ê° ê³¡ì„ ',
                    data: this.generateCurveData(plant.reviews[plant.reviews.length-1].date, plant.strength),
                    borderColor: 'rgba(234, 67, 53, 0.8)', tension: 0.4, pointRadius: 0
                }];
                plant.reviews.forEach((review, index) => {
                    datasets.push({
                        label: `${index + 1}ì°¨ ë³µìŠµ`, data: [{x: new Date(review.date), y: 100}],
                        borderColor: 'rgba(52, 168, 83, 1)', backgroundColor: 'rgba(52, 168, 83, 1)',
                        pointStyle: 'rectRot', radius: 7
                    });
                });
                return { type: 'line', data: { datasets }, options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { min: 0, max: 105, title: { display: true, text: 'ê¸°ì–µ ë³´ìœ ëŸ‰ (%)' } } }, plugins: { legend: { position: 'bottom' } } } };
            },
            initJourneyMap() {
                this.load();
                const container = document.getElementById('journey-map-container');
                const svg = document.getElementById('journey-map-svg');
                while (container.firstChild) { container.removeChild(container.firstChild); }
                container.appendChild(svg);
                svg.innerHTML = '';
                if (this.plants.length === 0) { container.innerHTML = `<p class="empty-message">ì•„ì§ íƒí—˜í•œ ì§€ì‹ì´ ì—†ìŠµë‹ˆë‹¤. ì—¬ì •ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>`; return; }
                const books = [...new Set(this.plants.map(p => p.sourceBook))];
                const nodes = [];
                const cWidth = container.clientWidth, cHeight = container.clientHeight;
                const centerX = cWidth / 2, centerY = cHeight / 2;
                books.forEach((bookTitle, i) => {
                    const angle = (i / books.length) * 2 * Math.PI, radius = Math.min(centerX, centerY) * 0.6;
                    const x = centerX + radius * Math.cos(angle), y = centerY + radius * Math.sin(angle);
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'journey-node book';
                    nodeEl.textContent = bookTitle;
                    nodeEl.style.left = `${x - 50}px`; nodeEl.style.top = `${y - 50}px`;
                    container.appendChild(nodeEl);
                    nodes.push({ id: bookTitle, x, y, el: nodeEl, type: 'book' });
                });
                this.plants.forEach(plant => {
                    const parent = nodes.find(n => n.id === plant.sourceBook);
                    if (!parent) return;
                    const pAngle = Math.random() * 2 * Math.PI, pRadius = 80 + Math.random() * 20;
                    const x = parent.x + pRadius * Math.cos(pAngle), y = parent.y + pRadius * Math.sin(pAngle);
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'journey-node plant';
                    nodeEl.textContent = plant.title.substring(0, 10) + '...';
                    nodeEl.style.left = `${x - 35}px`; nodeEl.style.top = `${y - 35}px`;
                    container.appendChild(nodeEl);
                    nodes.push({ id: plant.id, x, y, el: nodeEl, type: 'plant' });
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', parent.x); line.setAttribute('y1', parent.y);
                    line.setAttribute('x2', x); line.setAttribute('y2', y);
                    line.setAttribute('stroke', 'var(--border-color)'); line.setAttribute('stroke-width', 2);
                    svg.appendChild(line);
                });
            }
        };
        
        // =================================================================================
        // GoalNavigator Module: Manages the AI goal setting process
        // =================================================================================
        const GoalNavigator = {
            state: {}, 
            init() { const el = document.getElementById('book-title-for-goal'); const title = el ? el.value : ''; if (!title.trim()) { UI.showToast('ì±… ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error'); el.focus(); return; } this.state = { bookTitle: title, mode: null, selectedGoal: null }; UI.GoalNavigator.content.removeEventListener('click', this.handleEvents); UI.GoalNavigator.content.addEventListener('click', this.handleEvents.bind(this)); this.render('modeSelection', { bookTitle: title }); UI.GoalNavigator.show(); }, 
            handleEvents(e) { const t = e.target; const mb = t.closest('.mode-select-btn'); if (mb) { this.selectMode(mb.dataset.mode); return; } const gc = t.closest('.goal-card'); if (gc) { this.state.selectedGoal = { level: gc.dataset.level, text: gc.dataset.text }; this.render('architect', this.state.selectedGoal); return; } const ssb = t.closest('#solver-submit-problem'); if (ssb) { const pi = document.getElementById('solver-problem-input'); if (!pi.value.trim()) { UI.showToast('í•´ê²°í•  ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); pi.focus(); return; } this.state.selectedGoal = this.getSolverGoal(this.state.bookTitle, pi.value); this.render('architect', this.state.selectedGoal); return; } const acb = t.closest('#architect-confirm-goal'); if (acb) { this.state.selectedGoal.text = document.getElementById('architect-goal-editor').value; document.dispatchEvent(new CustomEvent('goalSelected', { detail: this.state.selectedGoal })); UI.GoalNavigator.hide(); return; } }, 
            render(step, data) { UI.GoalNavigator.render(step, data); }, 
            selectMode(mode) { this.state.mode = mode; if (mode === 'explorer') this.render('explorer', { goalPack: this.getGoalPack(this.state.bookTitle) }); else if (mode === 'solver') this.render('solver'); }, 
            getGoalPack: (title) => [{level:1,text:`'${title}'ì—ì„œ 'í•µì‹¬ ê°œë… A' ì •ì˜ ì°¾ê¸°`},{level:2,text:`'${title}'ì˜ 1ë¶€ ì›ì¹™ 3ê°€ì§€ë¡œ ë‚´ ë¬¸ì œ í•´ê²°í•˜ê¸°`}], 
            getSolverGoal: (title, prob) => ({level:2,text:`'${title}' ë‚´ìš©ìœ¼ë¡œ '${prob.substring(0,20)}...' ë¬¸ì œ í•´ê²° ì „ëµ 3ê°€ì§€ ë„ì¶œ`})
        };

        // =================================================================================
        // App Initialization and Global Event Listeners
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            const app = document.querySelector('.app-container');
            let currentPlant = null;
            
            app.addEventListener('click', (e) => {
                const target = e.target;
                
                // Sidebar Navigation
                const navBtn = target.closest('.nav-btn');
                if (navBtn) {
                    const view = navBtn.dataset.view;
                    UI.switchView(view, document.querySelectorAll('.nav-btn'));
                    if (view === 'garden') Ebbinghaus.initGarden();
                    if (view === 'journey') Ebbinghaus.initJourneyMap();
                    return;
                }

                // Dashboard Controls
                if (target.closest('.course-btn')) {
                    document.querySelectorAll('.course-btn').forEach(b => b.classList.remove('active'));
                    target.closest('.course-btn').classList.add('active');
                    return;
                }
                if (target.closest('#start-session-btn')) { UI.switchView('metis-session', document.querySelectorAll('.nav-btn')); MetisSession.init(); return; }
                if (target.closest('#start-goal-navigator-btn')) { GoalNavigator.init(); return; }
                
                // Metis Session Controls
                const sessionView = target.closest('#metis-session');
                if(sessionView){
                    if (target.closest('#back-to-dashboard-btn')) { UI.showConfirm("ì„¸ì…˜ì„ ì¤‘ë‹¨í•˜ê³  ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?", () => document.dispatchEvent(new CustomEvent('sessionComplete', { detail: { finished: false } }))); return; }
                    if (target.closest('.next-step-btn')) { MetisSession.proceed(); return; }
                    if (target.id === 'finish-reading-btn') { MetisSession.handleFocusEnd(); return; }
                    if (target.id === 'start-next-cycle-btn') { MetisSession.handleBreakEnd(); return; }
                    if (target.id === 'finish-session-btn') { MetisSession.complete(); return; }
                }

                // Garden and Dashboard Modal Controls
                const plantCard = target.closest('.plant-card');
                if (plantCard) {
                    const plantId = plantCard.dataset.id;
                    currentPlant = Ebbinghaus.getPlantById(plantId);
                    if (!currentPlant) return;
                    if (currentPlant.status === 'healthy') {
                        UI.Dashboard.show(currentPlant, Ebbinghaus.createChartConfig(currentPlant));
                    } else {
                        Ebbinghaus.startReview(plantId);
                    }
                    return;
                }
                if (target.closest('#dashboard-modal-overlay') && !target.closest('.modal-content')) { UI.Dashboard.hide(); return; }
                const simulateBtn = target.closest('#simulate-review-btn');
                if (simulateBtn) {
                    if(!currentPlant) return;
                    const simulatedStrength = currentPlant.strength + 1;
                    const simulatedData = {
                        label: 'ì‹œë®¬ë ˆì´ì…˜: ì˜¤ëŠ˜ ë³µìŠµ ì‹œ',
                        data: Ebbinghaus.generateCurveData(new Date(), simulatedStrength),
                        borderColor: 'rgba(66, 133, 244, 0.5)', borderDash: [5, 5], tension: 0.4, pointRadius: 0
                    };
                    UI.Dashboard.updateChart(simulatedData);
                    simulateBtn.disabled = true;
                    simulateBtn.textContent = 'âœ… ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ';
                    return;
                }
            });

            document.addEventListener('sessionComplete', (e) => {
                if (e.detail.finished) {
                    Ebbinghaus.plantSeed(e.detail.data);
                }
                MetisSession.reset();
                const view = e.detail.finished ? 'garden' : 'dashboard';
                UI.switchView(view, document.querySelectorAll('.nav-btn'));
                if(view === 'garden') Ebbinghaus.initGarden();
            });

            document.addEventListener('goalSelected', (e) => {
                const { level, text } = e.detail;
                document.querySelector('#main-book-goal').innerHTML = `<strong>ğŸ¯ í˜„ì¬ ëª©í‘œ (ë ˆë²¨ ${level})</strong><p>${text}</p>`;
            });
            
            // Initial Load
            UI.switchView('dashboard', document.querySelectorAll('.nav-btn'));
        });
    </script>
</body>
</html>

