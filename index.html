<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Metis: Knowledge Compounding Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #4285F4;
            --primary-dark: #3367D6;
            --background-color: #f0f4f9;
            --surface-color: #ffffff;
            --text-color: #3c4043;
            --text-light-color: #5f6368;
            --border-color: #dadce0;
            --font-family: 'Noto Sans KR', sans-serif;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            --border-radius: 8px;
            /* 상태별 색상 정의 */
            --color-healthy: #34A853; /* 초록 */
            --color-needs-care: #FBBC04; /* 노랑 */
            --color-urgent: #EA4335; /* 빨강 */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 240px; background-color: var(--surface-color); padding: 24px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .sidebar h1 { font-size: 24px; color: var(--primary-color); margin-bottom: 32px; }
        .sidebar nav { display: flex; flex-direction: column; gap: 8px; }
        .nav-btn { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--border-radius); border: none; background-color: transparent; cursor: pointer; text-align: left; font-size: 16px; font-weight: 500; color: var(--text-light-color); transition: background-color 0.2s, color 0.2s; }
        .nav-btn .icon { font-size: 20px; }
        .nav-btn:hover { background-color: var(--background-color); }
        .nav-btn.active { background-color: #E8F0FE; color: var(--primary-dark); }
        .main-content { flex: 1; overflow-y: auto; padding: 32px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        .view-header { margin-bottom: 24px; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
        .view-header h2 { font-size: 28px; margin-bottom: 4px; }
        .view-header p { color: var(--text-light-color); font-size: 16px; }
        .card { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 24px; margin-bottom: 24px; }
        .btn { padding: 10px 20px; font-size: 16px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--surface-color); cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn:hover { background-color: #f1f3f4; }
        .btn.active { background-color: #E8F0FE; color: var(--primary-dark); border-color: var(--primary-color); }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-secondary { background-color: transparent; color: var(--text-light-color); border: none; }
        .btn-secondary:hover { background-color: #f1f3f4; color: var(--text-color); }
        textarea, input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-family: var(--font-family); font-size: 16px; margin-bottom: 16px; }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus { outline: 2px solid var(--primary-color); border-color: var(--primary-color); }
        textarea { min-height: 120px; resize: vertical; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .main-book-slot { grid-column: 1 / 2; grid-row: 1 / 3; }
        .book-info { display: flex; gap: 20px; margin-bottom: 24px; }
        .book-cover { width: 150px; height: auto; object-fit: cover; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .book-details h4 { font-size: 20px; }
        .book-details .goal { margin-top: 16px; }
        .main-book-slot .btn-primary { width: 100%; padding: 16px; font-size: 18px; }
        .sub-book-shelf-container { grid-column: 2 / 3; }
        .sub-book-shelf { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; }
        .sub-book-cover { height: 120px; border-radius: 4px; box-shadow: var(--shadow); }
        .ai-assistant-slot .book-title-input { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        
        .course-selection { margin-top: 16px; }
        .course-selection h5 { margin-bottom: 8px; color: var(--text-light-color); }
        .course-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .course-btn { flex-grow: 1; }
        
        /* 지식 정원 & 기억 곡선 대시보드 스타일 */
        .garden-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 24px; }
        .plant-card { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); border-left: 5px solid; padding: 16px; transition: all 0.2s; cursor: pointer; }
        .plant-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .plant-card.healthy { border-left-color: var(--color-healthy); }
        .plant-card.needs-care { border-left-color: var(--color-needs-care); }
        .plant-card.urgent { border-left-color: var(--color-urgent); }
        .plant-title { font-weight: 700; margin-bottom: 8px; }
        .plant-source { font-size: 14px; color: var(--text-light-color); margin-bottom: 12px; }
        .plant-status { font-size: 14px; font-weight: 500; }
        .dashboard-modal-content { max-width: 800px; width: 90%; }
        .dashboard-header { margin-bottom: 16px; }
        .dashboard-grid-layout { display: grid; grid-template-columns: 1fr 250px; gap: 24px; }
        .chart-container { position: relative; height: 350px; }
        .empty-message { text-align: center; color: var(--text-light-color); grid-column: 1 / -1; padding: 40px; }

        /* 메티스 세션 */
        .session-content { max-width: 800px; margin: 0 auto; }
        .session-progress { text-align: center; margin-bottom: 16px; font-size: 18px; color: var(--text-light-color); }
        .goal-display { background-color: var(--background-color); border-left: 4px solid var(--primary-color); padding: 16px; margin-bottom: 24px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s; }
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;}
        .step h4 { font-size: 22px; margin: 0; }
        .step-timer { font-size: 18px; font-weight: 700; color: var(--primary-dark); }
        #timer { font-size: 48px; font-weight: 700; text-align: center; color: var(--primary-dark); margin: 24px 0; }
        #step-break { background-color: #e8f0fe; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .comparison-col h5 { margin-bottom: 8px; color: var(--text-light-color); }
        .comparison-content { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; min-height: 150px; overflow-y: auto; }
        textarea.final-writing { min-height: 250px; }
        
        /* 모달, 로더, 토스트 */
        .loader-overlay, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .loader { border: 6px solid rgba(255,255,255,0.3); border-top: 6px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .loader-text { color: white; margin-top: 16px; font-size: 16px; }
        .modal-content { background: var(--surface-color); padding: 32px; border-radius: var(--border-radius); width: 90%; max-width: 700px; animation: fadeIn 0.3s; }
        .modal-controls { margin-top: 24px; display: flex; justify-content: flex-end; gap: 8px; }
        .challenge-title { font-size: 22px; color: var(--primary-dark); margin-bottom: 8px; }
        .challenge-description { color: var(--text-light-color); margin-bottom: 16px; }
        .challenge-prompt { background-color: var(--background-color); border-left: 4px solid var(--primary-color); padding: 16px; margin: 24px 0; border-radius: 4px; font-style: italic; }
        .confidence-rating { margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 16px; }
        #goal-navigator-modal .modal-header { text-align: center; margin-bottom: 24px; }
        .mode-selection-container { display: flex; justify-content: space-around; gap: 20px; }
        .mode-select-btn { flex: 1; padding: 20px; text-align: center; border: 2px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .mode-select-btn:hover { border-color: var(--primary-color); background-color: #E8F0FE; }
        .goal-pack-container { max-height: 40vh; overflow-y: auto; padding: 8px; }
        .goal-card { background: var(--background-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; margin-bottom: 12px; cursor: pointer; }
        .goal-card:hover { border-color: var(--primary-color); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--text-color); color: white; padding: 12px 24px; border-radius: var(--border-radius); z-index: 2000; animation: toast-in 0.5s, toast-out 0.5s 2.5s; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        
        /* 지적 여정 맵 스타일 */
        #journey-map-container { position: relative; width: 100%; height: 75vh; background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); overflow: hidden; }
        .journey-node { position: absolute; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; text-align: center; font-size: 14px; padding: 5px; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s; user-select: none; }
        .journey-node:hover { transform: scale(1.1); z-index: 20 !important; }
        .journey-node.book { width: 100px; height: 100px; background-color: var(--primary-dark); z-index: 10; font-weight: 700; }
        .journey-node.plant { width: 70px; height: 70px; font-size: 11px; z-index: 5; }
        #journey-map-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-in { from { bottom: -50px; opacity: 0; } to { bottom: 20px; opacity: 1; } }
        @keyframes toast-out { from { bottom: 20px; opacity: 1; } to { bottom: -50px; opacity: 0; } }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <h1>Project Metis</h1>
            <nav>
                <button class="nav-btn active" data-view="dashboard">
                    <span class="icon">🏠</span> 대시보드
                </button>
                <button class="nav-btn" data-view="garden">
                    <span class="icon">🌿</span> 지식 정원
                </button>
                <button class="nav-btn" data-view="journey">
                    <span class="icon">🗺️</span> 지적 여정 맵
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <!-- ============== Dashboard View ============== -->
            <div id="dashboard" class="view active">
                <header class="view-header">
                    <h2>오늘의 지식 탐험</h2>
                    <p>메인북을 중심으로 새로운 지식을 탐험하고, 당신의 자산으로 만드세요.</p>
                </header>
                <div class="dashboard-grid">
                    <div id="main-book-slot" class="main-book-slot card">
                        <h3>📘 메인북</h3>
                        <div class="book-info">
                            <img src="https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1593003033l/54495910.jpg" alt="Nudge book cover" class="book-cover">
                            <div class="book-details">
                                <h4>넛지 (Nudge)</h4>
                                <p>리처드 H. 탈러, 캐스 R. 선스타인</p>
                                <div id="main-book-goal" class="goal">
                                    <strong>🎯 현재 목표 (레벨 2)</strong>
                                    <p>선택 설계의 3요소(디폴트, 피드백, 오류 예상)를 설명하고, 실생활 사례 1가지씩 찾아보기.</p>
                                </div>
                            </div>
                        </div>
                        <div class="course-selection">
                            <h5>학습 코스 선택</h5>
                            <div class="course-buttons">
                                <button class="course-btn btn active" data-duration="30">30분 코스</button>
                                <button class="course-btn btn" data-duration="60">60분 코스</button>
                                <button class="course-btn btn" data-duration="90">90분 코스</button>
                                <button class="course-btn btn" data-duration="120">120분 코스</button>
                            </div>
                        </div>
                        <button id="start-session-btn" class="btn btn-primary" style="margin-top: 16px;">새로운 지식 탐험하기 (메티스 세션)</button>
                    </div>
                    <div class="ai-assistant-slot card">
                        <h3>🤖 AI 목표 내비게이터</h3>
                        <p>책을 통해 무엇을 얻고 싶으신가요? AI가 최적의 학습 목표 설정을 도와드립니다.</p>
                        <div class="book-title-input">
                            <label for="book-title-for-goal">대상 도서:</label>
                            <input type="text" id="book-title-for-goal" value="넛지 (Nudge)" placeholder="책 제목을 입력하세요">
                        </div>
                        <button id="start-goal-navigator-btn" class="btn">AI 목표 설정 시작하기</button>
                    </div>
                    <div class="sub-book-shelf-container card">
                        <h3>📚 관심 서재 (서브북)</h3>
                        <div class="sub-book-shelf">
                            <img src="https://image.aladin.co.kr/product/30883/29/cover500/k252830635_1.jpg" alt="Book cover 1" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/10/3/cover500/8932917248_2.jpg" alt="Book cover 2" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/33359/29/cover500/k252938250_1.jpg" alt="Book cover 3" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/1324/3/cover500/890120935x_1.jpg" alt="Book cover 4" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/29306/17/cover500/s972837389_1.jpg" alt="Book cover 5" class="sub-book-cover">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ============== Knowledge Garden View ============== -->
            <div id="garden" class="view">
                <header class="view-header">
                    <h2>🌿 지식 정원</h2>
                    <p>당신의 모든 지식 자산(식물)이 자라고 있습니다. 상태를 보고 관리해주세요.</p>
                </header>
                <div class="garden-container" id="garden-container">
                    <!-- Knowledge plants will be rendered here -->
                </div>
            </div>

            <!-- ============== Journey Map View ============== -->
            <div id="journey" class="view">
                <header class="view-header">
                    <h2>🗺️ 지적 여정 맵</h2>
                    <p>당신의 지식들이 어떻게 연결되어 있는지 탐험하세요.</p>
                </header>
                <div id="journey-map-container">
                    <svg id="journey-map-svg"></svg>
                    <!-- Nodes will be rendered here via JS -->
                </div>
            </div>

            <!-- ============== Metis Session View ============== -->
            <div id="metis-session" class="view">
                 <header class="view-header">
                     <button id="back-to-dashboard-btn" class="btn btn-secondary">← 뒤로가기</button>
                     <h2>🧠 메티스 학습 세션</h2>
                     <p id="step-title">단계 1: 학습 예측</p>
                 </header>
                 <div class="session-content">
                    <div class="session-progress" id="session-progress"></div>
                     <!-- Step 1: Prediction -->
                     <div id="step-1" class="step active card">
                        <div class="step-header">
                            <h4>[1/7] 학습 예측 (Prediction)</h4>
                            <div class="step-timer" id="timer-step-1">05:00</div>
                        </div>
                        <p>5분 안에, 위 목표와 관련하여 책에서 어떤 내용을 다룰 것 같습니까? 핵심 내용을 예측해보세요.</p>
                        <textarea id="prediction-input" placeholder="예: 넛지의 개념을 설명하고, 사람들의 비합리적 선택을 유도하는 사례를 보여줄 것 같다."></textarea>
                        <button class="btn btn-primary next-step-btn">예측 완료, 집중 독서 시작</button>
                    </div>
                    <!-- Step 2: Reading -->
                     <div id="step-2" class="step card">
                         <h4>[2/7] 집중 독서 (Focused Reading)</h4>
                         <p>이제 25분간 목표에만 집중하여 책을 읽습니다. 몰입을 위해 방해 요소를 제거하세요.</p>
                         <div id="timer">25:00</div>
                         <button class="btn btn-primary" id="finish-reading-btn">독서 완료</button>
                     </div>
                    <!-- Break Step -->
                    <div id="step-break" class="step card">
                        <h4>☕️ 5분 휴식 (Active Break)</h4>
                        <p>잠시 휴식을 취하며 뇌를 정리합니다. 아래 질문에 대해 가볍게 생각해보세요.</p>
                        <div id="timer-break">05:00</div>
                        <div class="card">
                            <h5>중간 예측 점검</h5>
                            <p>지금까지 읽은 내용을 바탕으로, 처음의 예측을 수정하거나 보완하고 싶은 부분이 있나요?</p>
                        </div>
                        <button class="btn btn-primary" id="start-next-cycle-btn">휴식 완료, 다음 세션 시작</button>
                    </div>
                    <!-- Step 3: Brain Dump -->
                     <div id="step-3" class="step card">
                        <div class="step-header">
                            <h4>[3/7] 생각 기록 (Brain Dump)</h4>
                            <div class="step-timer" id="timer-step-3">05:00</div>
                        </div>
                        <p>5분 안에, 방금 읽은 내용과 그에 대한 당신의 생각을 자유롭게 기록하세요.</p>
                        <textarea id="braindump-input" placeholder="정리되지 않아도 괜찮습니다. 떠오르는 모든 것을 기록하세요."></textarea>
                        <button class="btn btn-primary next-step-btn">기록 완료</button>
                    </div>
                    <!-- Step 4: AI Prediction -->
                     <div id="step-4" class="step card">
                        <div class="step-header">
                            <h4>[4/7] AI 피드백 예측 (Metacognition)</h4>
                            <div class="step-timer" id="timer-step-4">05:00</div>
                        </div>
                        <p>5분 안에, AI가 당신의 기록에 대해 어떤 피드백을 줄 것 같습니까? 당신이 놓친 부분은 무엇일까요?</p>
                        <textarea id="ai-prediction-input" placeholder="예: 개념 설명은 잘했지만, 각 요소가 어떻게 상호작용하는지에 대한 설명이 부족하다고 지적할 것 같다."></textarea>
                        <button class="btn btn-primary next-step-btn">예측 완료</button>
                    </div>
                    <!-- Step 5: Reveal -->
                    <div id="step-5" class="step card">
                        <div class="step-header">
                            <h4>[5/7] 비교 분석 (The Reveal)</h4>
                        </div>
                        <p>자신의 이해도와 실제 이해도 사이의 격차(Gap)를 객관적으로 인지하세요.</p>
                        <div class="comparison-grid">
                            <div class="comparison-col"><h5>🤔 내 생각</h5><div id="reveal-my-thoughts" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5>🤖 AI 피드백</h5><div id="reveal-ai-feedback" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5>🔮 내 예측</h5><div id="reveal-my-prediction" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5> A 전문가 요약</h5><div id="reveal-expert-summary" class="comparison-content"></div></div>
                        </div>
                        <button class="btn btn-primary next-step-btn">분석 완료</button>
                    </div>
                    <!-- Step 6: Gap Extraction -->
                     <div id="step-6" class="step card">
                        <div class="step-header">
                            <h4>[6/7] 글쓰기를 위한 핵심 질문 추출</h4>
                            <div class="step-timer" id="timer-step-6">05:00</div>
                        </div>
                        <p>5분 안에, 당신의 생각과 AI의 분석 사이에서 발견한 '격차(Gap)'를 해소할 핵심 질문 하나를 뽑아보세요.</p>
                        <textarea id="gap-input" placeholder="예: 나는 개념의 나열에 그쳤지만, AI는 '개념 간의 연결성 부족'을 지적했다. 그렇다면, 각 개념들은 어떻게 유기적으로 연결되는가?"></textarea>
                        <button class="btn btn-primary next-step-btn">질문 추출 완료</button>
                    </div>
                    <!-- Step 7: Final Writing -->
                     <div id="step-7" class="step card">
                        <div class="step-header">
                             <h4>[7/7] 완벽한 체화를 위한 글쓰기</h4>
                             <div class="step-timer" id="timer-step-7">05:00</div>
                        </div>
                         <p>5분 안에, 방금 추출한 질문에 대한 답을 스스로 설명하는 한 편의 글을 완성하세요.</p>
                         <textarea id="final-writing-input" class="final-writing" placeholder="6단계에서 뽑아낸 질문을 바탕으로, 오늘 배운 내용을 다른 사람에게 설명하듯 자유롭게 글을 작성해보세요."></textarea>
                         <button id="finish-session-btn" class="btn btn-primary">글쓰기 완료, 지식 정원에 씨앗 심기</button>
                     </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- ============== Modals ============== -->
    <div id="loader" class="loader-overlay"><div class="loader"></div><div class="loader-text">AI가 당신의 생각을 분석 중입니다...</div></div>
    <div id="challenge-modal-overlay" class="modal-overlay"><div id="challenge-modal" class="modal-content"></div></div>
    <div id="goal-navigator-modal-overlay" class="modal-overlay"><div id="goal-navigator-modal" class="modal-content"><div id="goal-navigator-content"></div></div></div>
    <!-- 기억 곡선 대시보드 모달 -->
    <div id="dashboard-modal-overlay" class="modal-overlay">
        <div id="dashboard-modal" class="modal-content dashboard-modal-content">
            <div class="dashboard-header">
                <h3 id="dashboard-title">기억 곡선 대시보드</h3>
                <p id="dashboard-source"></p>
            </div>
            <div class="dashboard-grid-layout">
                <div class="chart-container">
                    <canvas id="memoryCurveChart"></canvas>
                </div>
                <div class="analysis-panel">
                    <h4>상태 분석</h4>
                    <p id="dashboard-status-analysis"></p>
                    <hr style="margin: 16px 0;">
                    <h4>시뮬레이션</h4>
                    <p>지금 복습하면 미래의 기억 곡선이 어떻게 변할까요?</p>
                    <button id="simulate-review-btn" class="btn btn-primary" style="width: 100%; margin-top: 8px;">오늘 복습 시뮬레이션</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =================================================================================
        // UI Module: Handles all DOM manipulations and rendering
        // =================================================================================
        const UI = {
            switchView(viewName, navButtons) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewName)?.classList.add('active'); navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName)); },
            switchStep(step) { 
                document.querySelectorAll('#metis-session .step').forEach(s => s.classList.remove('active')); 
                const el = document.getElementById(step);
                if (el) { 
                    el.classList.add('active'); 
                    const titleEl = el.querySelector('h4');
                    if (titleEl) document.getElementById('step-title').textContent = titleEl.textContent; 
                } 
            },
            updateTimer(timeLeft, elementId) { const min = Math.floor(timeLeft / 60), sec = timeLeft % 60; const timerEl = document.getElementById(elementId); if (timerEl) timerEl.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; },
            updateProgress(progress) { const el = document.getElementById('session-progress'); if (el) el.innerHTML = progress;},
            showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; },
            showToast(message, type = 'info') { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); },
            showConfirm(msg, onConfirm) { const ov = document.createElement('div'); ov.className = 'modal-overlay'; ov.style.display = 'flex'; const md = document.createElement('div'); md.className = 'modal-content'; md.innerHTML = `<p>${msg}</p><div class="modal-controls"><button id="c-cancel" class="btn">취소</button><button id="c-ok" class="btn btn-primary">확인</button></div>`; ov.appendChild(md); document.body.appendChild(ov); ov.onclick = e => { if (e.target.id === 'c-ok') onConfirm(); if (e.target.closest('#c-cancel') || e.target.closest('#c-ok') || e.target === ov) ov.remove(); }; },
            GoalNavigator: { overlay: document.getElementById('goal-navigator-modal-overlay'), content: document.getElementById('goal-navigator-content'), show() { this.overlay.style.display = 'flex'; }, hide() { this.overlay.style.display = 'none'; }, render(step, data) { let html = ''; switch (step) { case 'modeSelection': html = `<div class="modal-header"><h3>AI 목표 내비게이터</h3><p><strong>${data.bookTitle}</strong> 학습 목표 설정을 시작합니다.</p></div><div class="mode-selection-container"><div class="mode-select-btn" data-mode="explorer"><h4>🧭 탐험가 모드</h4><p>AI 생성 목표 팩에서 선택</p></div><div class="mode-select-btn" data-mode="solver"><h4>🛠️ 해결사 모드</h4><p>문제 입력, 맞춤형 목표 생성</p></div></div>`; break; case 'explorer': html = `<div class="modal-header"><h3>🧭 탐험가 모드</h3><p>가장 마음에 드는 목표를 선택하세요.</p></div><div class="goal-pack-container">${data.goalPack.map(g => `<div class="goal-card" data-level="${g.level}" data-text="${g.text}"><strong>[레벨 ${g.level}]</strong> ${g.text}</div>`).join('')}</div>`; break; case 'solver': html = `<div class="modal-header"><h3>🛠️ 해결사 모드</h3><p>이 책으로 해결하고 싶은 문제를 알려주세요.</p></div><div><textarea id="solver-problem-input" placeholder="예: 면접관의 의도를 파악하고 싶어요."></textarea></div><div class="modal-controls"><button id="solver-submit-problem" class="btn btn-primary">목표 생성</button></div>`; break; case 'architect': html = `<div class="modal-header"><h3>✅ 목표 확정</h3><p>AI 제안 목표를 수정하여 확정하세요.</p></div><div><textarea id="architect-goal-editor">${data.text}</textarea></div><div class="modal-controls"><button id="architect-confirm-goal" class="btn btn-primary">메인 목표로 설정</button></div>`; break; } this.content.innerHTML = html; } },
            renderGarden(plants) {
                const container = document.getElementById('garden-container');
                container.innerHTML = '';
                if (plants.length === 0) {
                    container.innerHTML = `<p class="empty-message">아직 정원에 식물이 없습니다. 메티스 세션을 통해 첫 씨앗을 심어보세요!</p>`;
                    return;
                }
                plants.sort((a,b) => a.daysUntilReview - b.daysUntilReview).forEach(plant => {
                    const el = document.createElement('div');
                    el.className = `plant-card ${plant.status}`;
                    el.dataset.id = plant.id;
                    const reviewText = plant.daysUntilReview > 0 ? `복습까지 ${plant.daysUntilReview}일` : '오늘 복습!';
                    el.innerHTML = `<div class="plant-title">${plant.title}</div><div class="plant-source">${plant.sourceBook}</div><div class="plant-status">${reviewText}</div>`;
                    container.appendChild(el);
                });
            },
            Dashboard: {
                overlay: document.getElementById('dashboard-modal-overlay'),
                title: document.getElementById('dashboard-title'),
                source: document.getElementById('dashboard-source'),
                status: document.getElementById('dashboard-status-analysis'),
                chartCanvas: document.getElementById('memoryCurveChart'),
                chart: null,
                show(plant, chartData) {
                    this.title.textContent = `"${plant.title}" 기억 곡선`;
                    this.source.textContent = `출처: ${plant.sourceBook}`;
                    this.status.textContent = `현재 이 지식은 '${plant.memoryStage}' 상태입니다. 기억 강도는 ${plant.strength}입니다.`;
                    
                    document.getElementById('simulate-review-btn').disabled = false;
                    document.getElementById('simulate-review-btn').textContent = '오늘 복습 시뮬레이션';

                    if (this.chart) this.chart.destroy();
                    this.chart = new Chart(this.chartCanvas, chartData);
                    
                    this.overlay.style.display = 'flex';
                },
                hide() { this.overlay.style.display = 'none'; },
                updateChart(newData) {
                    if (!this.chart) return;
                    const existingSimIndex = this.chart.data.datasets.findIndex(d => d.label.includes('시뮬레이션'));
                    if(existingSimIndex > -1) this.chart.data.datasets.splice(existingSimIndex, 1);
                    this.chart.data.datasets.push(newData);
                    this.chart.update();
                }
            },
            Challenge: {
                overlay: document.getElementById('challenge-modal-overlay'),
                content: document.getElementById('challenge-modal'),
                show(challenge, onComplete) {
                    let challengeHTML = '';
                    switch (challenge.type) {
                        case 'connect':
                            challengeHTML = `<h3 class="challenge-title">챌린지 Lv.2: 사례 연결</h3> <p class="challenge-description">이 지식을 설명할 수 있는 최근 뉴스 기사나 당신의 개인적인 경험 한 가지를 제시하세요.</p>`;
                            break;
                        case 'critique':
                            challengeHTML = `<h3 class="challenge-title">챌린지 Lv.3: 비판적 사고</h3> <p class="challenge-description">이 지식의 한계점이나 잠재적인 반론은 무엇일까요?</p>`;
                            break;
                        default:
                            challengeHTML = `<h3 class="challenge-title">챌린지 Lv.1: 핵심 내용 인출</h3> <p class="challenge-description">"${challenge.sourceBook}"에서 배운 내용을 떠올려보세요.</p>`;
                            break;
                    }
                    this.content.innerHTML = `${challengeHTML}
                        <div class="challenge-prompt">${challenge.question.replace(/\n/g, '<br>')}</div>
                        <textarea id="challenge-answer" placeholder="당신의 언어로 자유롭게 설명해보세요..."></textarea>
                        <div class="confidence-rating"><p>이번 답변에 얼마나 확신했나요?</p><div class="confidence-buttons"><button class="btn" data-confidence="confident">✅ 확신함</button><button class="btn" data-confidence="unsure">🤔 긴가민가함</button><button class="btn" data-confidence="guess">❓ 거의 추측함</button></div></div>
                        <div class="modal-controls"><button id="challenge-cancel-btn" class="btn">취소</button><button id="challenge-submit-btn" class="btn btn-primary" disabled>복습 완료</button></div>`;
                    this.overlay.style.display = 'flex';
                    let selectedConfidence = null;
                    const clickHandler = (e) => {
                        const target = e.target;
                        if(target.closest('.confidence-buttons .btn')){
                            this.content.querySelectorAll('.confidence-buttons .btn').forEach(b => b.classList.remove('active'));
                            target.closest('.btn').classList.add('active');
                            selectedConfidence = target.closest('.btn').dataset.confidence;
                            this.content.querySelector('#challenge-submit-btn').disabled = false;
                        } else if (target.id === 'challenge-cancel-btn' || target.id === 'challenge-submit-btn'){
                            if (target.id === 'challenge-submit-btn' && selectedConfidence) onComplete(selectedConfidence);
                            this.hide(clickHandler);
                        }
                    };
                    this.content.addEventListener('click', clickHandler);
                },
                hide(handler) { if(this.overlay) this.overlay.style.display = 'none'; if (handler) this.content.removeEventListener('click', handler); }
            }
        };

        // =================================================================================
        // MetisSession Module: Handles the 7-step learning cycle
        // =================================================================================
        const MetisSession = {
            state: {}, 
            writingSteps: ['step-1', 'step-3', 'step-4', 'step-6', 'step-7'],
            stepSequence: ['step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-6', 'step-7'],

            initialState: { 
                currentStepId: 'step-1', 
                userInputs: { prediction: '', brainDump: '', aiPrediction: '', gap: '', finalWriting: '' }, 
                timerInterval: null, 
                sourceBook: '', 
                initialGoal: '',
                totalDuration: 30,
                focusDuration: 25 * 60,
                breakDuration: 5 * 60,
                writingDuration: 5 * 60,
                timeLeft: 0,
                cyclesTotal: 1,
                cyclesCompleted: 0,
                currentPhase: 'writing', // writing, focus, break
            },
            
            init() { 
                this.reset();
                this.state.sourceBook = document.querySelector('#main-book-slot h4').textContent; 
                this.state.initialGoal = document.querySelector('#main-book-goal p').textContent; 
                
                const selectedCourse = document.querySelector('.course-btn.active');
                this.state.totalDuration = selectedCourse ? parseInt(selectedCourse.dataset.duration, 10) : 30;
                
                this.state.cyclesTotal = Math.floor(this.state.totalDuration / 30) * 2 - (this.state.totalDuration % 30 === 0 ? 1 : 0);
                if (this.state.totalDuration < 30) this.state.cyclesTotal = 1;
                
                document.getElementById('session-goal-display').innerHTML = document.getElementById('main-book-goal').innerHTML; 
                this.handleStepLogic(this.state.currentStepId);
            },
            
            reset() { 
                clearInterval(this.state.timerInterval); 
                this.state = JSON.parse(JSON.stringify(this.initialState)); 
            },

            startTimer(duration, elementId, onComplete) {
                if (this.state.timerInterval) clearInterval(this.state.timerInterval);
                this.state.timeLeft = duration;
                UI.updateTimer(this.state.timeLeft, elementId);

                this.state.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    UI.updateTimer(this.state.timeLeft, elementId);
                    if (this.state.timeLeft <= 0) {
                        clearInterval(this.state.timerInterval);
                        onComplete();
                    }
                }, 1000);
            },
            
            handleStepLogic(stepId) {
                this.state.currentStepId = stepId;
                UI.switchStep(stepId);
                clearInterval(this.state.timerInterval);
                
                if (this.writingSteps.includes(stepId)) {
                    this.state.currentPhase = 'writing';
                    const timerId = `timer-${stepId}`;
                    this.startTimer(this.state.writingDuration, timerId, () => this.proceed());
                } else if (stepId === 'step-2') {
                    this.state.currentPhase = 'focus';
                    UI.updateProgress(this.generateProgressHTML());
                    this.startTimer(this.state.focusDuration, 'timer', () => this.handleFocusEnd());
                } else if (stepId === 'step-break') {
                    this.state.currentPhase = 'break';
                    this.startTimer(this.state.breakDuration, 'timer-break', () => this.handleBreakEnd());
                }
            },

            proceed() {
                const currentId = this.state.currentStepId;
                
                // Save input if it's a writing step
                if (this.writingSteps.includes(currentId)) {
                    const inputId = `${currentId.split('-')[1]}-input`;
                    const inputEl = document.getElementById(inputId);
                    if(inputEl) {
                        const key = inputId.replace('-input', '').replace('prediction', 'prediction').replace('braindump', 'brainDump').replace('aiPrediction', 'aiPrediction').replace('gap', 'gap').replace('finalWriting', 'finalWriting');
                         if(this.state.userInputs.hasOwnProperty(key)) {
                             this.state.userInputs[key] = inputEl.value;
                         }
                    }
                }

                const currentIndex = this.stepSequence.indexOf(currentId);
                if (currentIndex < this.stepSequence.length - 1) {
                    const nextStepId = this.stepSequence[currentIndex + 1];
                    this.handleStepLogic(nextStepId);
                }
            },

            async handleFocusEnd() {
                this.state.cyclesCompleted++;
                if (this.state.cyclesCompleted < this.state.cyclesTotal) {
                    this.handleStepLogic('step-break');
                } else {
                    UI.showToast("모든 집중 세션 완료! 생각을 기록하세요.", "success");
                    this.handleStepLogic('step-3');
                }
            },

            handleBreakEnd() {
                UI.showToast("휴식 종료! 다음 세션을 시작합니다.", "success");
                this.handleStepLogic('step-2');
            },

            generateProgressHTML(){
                let html = '';
                for(let i = 0; i < this.state.cyclesTotal; i++){
                    html += (i < this.state.cyclesCompleted) ? '✅' : '🍅';
                    if(i < this.state.cyclesTotal - 1) html += ' ☕️ ';
                }
                return `Cycle ${this.state.cyclesCompleted + 1} / ${this.state.cyclesTotal} <br> ${html}`;
            },
            
            async completeSessionFlow() {
                UI.showLoader(true);
                const { brainDump, aiPrediction } = this.state.userInputs;
                const [feedback, summary] = await Promise.all([this.getAIFeedback(brainDump), this.getExpertSummary()]);
                document.getElementById('reveal-my-thoughts').textContent = brainDump || " ";
                document.getElementById('reveal-ai-feedback').textContent = feedback;
                document.getElementById('reveal-my-prediction').textContent = aiPrediction || " ";
                document.getElementById('reveal-expert-summary').textContent = summary;
                UI.showLoader(false);
                this.handleStepLogic('step-6');
            },

            complete() { 
                this.state.userInputs.finalWriting = document.getElementById('final-writing-input').value; 
                if (!this.state.userInputs.finalWriting.trim()) { 
                    UI.showToast('체화 글쓰기를 작성해야 캡슐을 봉인할 수 있습니다.', 'error'); return; 
                } 
                document.dispatchEvent(new CustomEvent('sessionComplete', { detail: { finished: true, data: this.state } })); 
            },

            simulateApi: (data, delay = 1000) => new Promise(res => setTimeout(() => res(data), delay)),
            getAIFeedback(text) { return this.simulateApi(`사용자의 기록을 분석한 결과, 핵심 개념은 파악했으나 각 요소 간의 유기적 '연결성'에 대한 설명이 부족합니다.`); },
            getExpertSummary() { return this.simulateApi(`**넛지(Nudge):** 인간은 체계적으로 편향되어 있으며, '선택 설계'를 통해 더 나은 결정을 내리도록 부드럽게 개입할 수 있다.`); }
        };

        // =================================================================================
        // Ebbinghaus Module: Manages knowledge plants, reviews, and journey map
        // =================================================================================
        const Ebbinghaus = {
            plants: [],
            getReviewInterval(strength) { if (strength <= 1) return 1; if (strength === 2) return 3; if (strength === 3) return 7; return Math.round(this.getReviewInterval(strength - 1) * 2.1); },
            load() { this.plants = JSON.parse(localStorage.getItem('knowledgePlants')) || []; this.plants.forEach(p => this.updatePlantState(p)); },
            updatePlantState(plant) { const now = new Date(); now.setHours(0, 0, 0, 0); const lastReviewed = new Date(plant.reviews[plant.reviews.length - 1].date); const interval = this.getReviewInterval(plant.strength); const nextReviewDate = new Date(lastReviewed); nextReviewDate.setDate(lastReviewed.getDate() + interval); nextReviewDate.setHours(0,0,0,0); plant.nextReviewDate = nextReviewDate; const diffDays = Math.ceil((nextReviewDate - now) / (1000 * 60 * 60 * 24)); plant.daysUntilReview = Math.max(0, diffDays); if (diffDays <= 0) plant.status = 'urgent'; else if (diffDays <= 3) plant.status = 'needs-care'; else plant.status = 'healthy'; if (plant.strength <= 2) plant.memoryStage = '단기 기억'; else if (plant.strength <= 4) plant.memoryStage = '장기 기억 전환 중'; else plant.memoryStage = '장기 기억'; },
            plantSeed(sessionData) { const { initialGoal, sourceBook, finalWriting, gap } = sessionData.userInputs; const newPlant = { id: Date.now(), title: initialGoal.substring(0, 40) + '...', sourceBook, question: `[핵심 질문] ${gap}\n\n위 질문에 대해 당신이 체화한 지식을 설명하세요.`, answer: finalWriting, strength: 1, reviews: [{ date: new Date().toISOString() }] }; if (!this.plants.some(p => p.question.includes(gap))) { this.plants.push(newPlant); localStorage.setItem('knowledgePlants', JSON.stringify(this.plants)); UI.showToast("지식 정원에 새로운 씨앗을 심었습니다!", "success"); } else UI.showToast("이미 동일한 질문의 씨앗이 존재합니다.", "error"); },
            initGarden() { this.load(); UI.renderGarden(this.plants); },
            getPlantById(id) { return this.plants.find(p => p.id == id); },
            startReview(plantId){
                const plant = this.getPlantById(plantId);
                if(!plant) return;
                let challengeType = 'recall';
                if(plant.strength >= 5) challengeType = 'critique';
                else if (plant.strength >= 3) challengeType = 'connect';
                const challenge = { type: challengeType, question: plant.question, sourceBook: plant.sourceBook };
                UI.Challenge.show(challenge, (confidence) => {
                    plant.reviews.push({ date: new Date().toISOString(), confidence });
                    if(confidence === 'confident') plant.strength += 1;
                    else if(confidence === 'guess') plant.strength = Math.max(1, plant.strength - 1);
                    localStorage.setItem('knowledgePlants', JSON.stringify(this.plants));
                    this.initGarden();
                    UI.showToast('복습 완료! 지식의 힘이 강해졌습니다.', 'success');
                });
            },
            generateCurveData(startDate, strength, days = 30) { const data = []; const decay = 0.3 / Math.log(strength + 1.5); for (let i = 0; i <= days; i++) { const d = new Date(startDate); d.setDate(d.getDate() + i); const retention = 100 * Math.exp(-i * decay); data.push({ x: d, y: retention }); } return data; },
            createChartConfig(plant) {
                const datasets = [{
                    label: '현재 망각 곡선',
                    data: this.generateCurveData(plant.reviews[plant.reviews.length-1].date, plant.strength),
                    borderColor: 'rgba(234, 67, 53, 0.8)', tension: 0.4, pointRadius: 0
                }];
                plant.reviews.forEach((review, index) => {
                    datasets.push({
                        label: `${index + 1}차 복습`, data: [{x: new Date(review.date), y: 100}],
                        borderColor: 'rgba(52, 168, 83, 1)', backgroundColor: 'rgba(52, 168, 83, 1)',
                        pointStyle: 'rectRot', radius: 7
                    });
                });
                return { type: 'line', data: { datasets }, options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { min: 0, max: 105, title: { display: true, text: '기억 보유량 (%)' } } }, plugins: { legend: { position: 'bottom' } } } };
            },
            initJourneyMap() {
                this.load();
                const container = document.getElementById('journey-map-container');
                const svg = document.getElementById('journey-map-svg');
                while (container.firstChild) { container.removeChild(container.firstChild); }
                container.appendChild(svg);
                svg.innerHTML = '';
                if (this.plants.length === 0) { container.innerHTML = `<p class="empty-message">아직 탐험한 지식이 없습니다. 여정을 시작해보세요!</p>`; return; }
                const books = [...new Set(this.plants.map(p => p.sourceBook))];
                const nodes = [];
                const cWidth = container.clientWidth, cHeight = container.clientHeight;
                const centerX = cWidth / 2, centerY = cHeight / 2;
                books.forEach((bookTitle, i) => {
                    const angle = (i / books.length) * 2 * Math.PI, radius = Math.min(centerX, centerY) * 0.6;
                    const x = centerX + radius * Math.cos(angle), y = centerY + radius * Math.sin(angle);
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'journey-node book';
                    nodeEl.textContent = bookTitle;
                    nodeEl.style.left = `${x - 50}px`; nodeEl.style.top = `${y - 50}px`;
                    container.appendChild(nodeEl);
                    nodes.push({ id: bookTitle, x, y, el: nodeEl, type: 'book' });
                });
                this.plants.forEach(plant => {
                    const parent = nodes.find(n => n.id === plant.sourceBook);
                    if (!parent) return;
                    const pAngle = Math.random() * 2 * Math.PI, pRadius = 80 + Math.random() * 20;
                    const x = parent.x + pRadius * Math.cos(pAngle), y = parent.y + pRadius * Math.sin(pAngle);
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'journey-node plant';
                    nodeEl.textContent = plant.title.substring(0, 10) + '...';
                    nodeEl.style.left = `${x - 35}px`; nodeEl.style.top = `${y - 35}px`;
                    container.appendChild(nodeEl);
                    nodes.push({ id: plant.id, x, y, el: nodeEl, type: 'plant' });
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', parent.x); line.setAttribute('y1', parent.y);
                    line.setAttribute('x2', x); line.setAttribute('y2', y);
                    line.setAttribute('stroke', 'var(--border-color)'); line.setAttribute('stroke-width', 2);
                    svg.appendChild(line);
                });
            }
        };
        
        // =================================================================================
        // GoalNavigator Module: Manages the AI goal setting process
        // =================================================================================
        const GoalNavigator = {
            state: {}, 
            init() { const el = document.getElementById('book-title-for-goal'); const title = el ? el.value : ''; if (!title.trim()) { UI.showToast('책 제목을 먼저 입력해주세요!', 'error'); el.focus(); return; } this.state = { bookTitle: title, mode: null, selectedGoal: null }; UI.GoalNavigator.content.removeEventListener('click', this.handleEvents); UI.GoalNavigator.content.addEventListener('click', this.handleEvents.bind(this)); this.render('modeSelection', { bookTitle: title }); UI.GoalNavigator.show(); }, 
            handleEvents(e) { const t = e.target; const mb = t.closest('.mode-select-btn'); if (mb) { this.selectMode(mb.dataset.mode); return; } const gc = t.closest('.goal-card'); if (gc) { this.state.selectedGoal = { level: gc.dataset.level, text: gc.dataset.text }; this.render('architect', this.state.selectedGoal); return; } const ssb = t.closest('#solver-submit-problem'); if (ssb) { const pi = document.getElementById('solver-problem-input'); if (!pi.value.trim()) { UI.showToast('해결할 문제를 입력해주세요.', 'error'); pi.focus(); return; } this.state.selectedGoal = this.getSolverGoal(this.state.bookTitle, pi.value); this.render('architect', this.state.selectedGoal); return; } const acb = t.closest('#architect-confirm-goal'); if (acb) { this.state.selectedGoal.text = document.getElementById('architect-goal-editor').value; document.dispatchEvent(new CustomEvent('goalSelected', { detail: this.state.selectedGoal })); UI.GoalNavigator.hide(); return; } }, 
            render(step, data) { UI.GoalNavigator.render(step, data); }, 
            selectMode(mode) { this.state.mode = mode; if (mode === 'explorer') this.render('explorer', { goalPack: this.getGoalPack(this.state.bookTitle) }); else if (mode === 'solver') this.render('solver'); }, 
            getGoalPack: (title) => [{level:1,text:`'${title}'에서 '핵심 개념 A' 정의 찾기`},{level:2,text:`'${title}'의 1부 원칙 3가지로 내 문제 해결하기`}], 
            getSolverGoal: (title, prob) => ({level:2,text:`'${title}' 내용으로 '${prob.substring(0,20)}...' 문제 해결 전략 3가지 도출`})
        };

        // =================================================================================
        // App Initialization and Global Event Listeners
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            const app = document.querySelector('.app-container');
            let currentPlant = null;
            
            app.addEventListener('click', (e) => {
                const target = e.target;
                
                // Sidebar Navigation
                const navBtn = target.closest('.nav-btn');
                if (navBtn) {
                    const view = navBtn.dataset.view;
                    UI.switchView(view, document.querySelectorAll('.nav-btn'));
                    if (view === 'garden') Ebbinghaus.initGarden();
                    if (view === 'journey') Ebbinghaus.initJourneyMap();
                    return;
                }

                // Dashboard Controls
                if (target.closest('.course-btn')) {
                    document.querySelectorAll('.course-btn').forEach(b => b.classList.remove('active'));
                    target.closest('.course-btn').classList.add('active');
                    return;
                }
                if (target.closest('#start-session-btn')) { UI.switchView('metis-session', document.querySelectorAll('.nav-btn')); MetisSession.init(); return; }
                if (target.closest('#start-goal-navigator-btn')) { GoalNavigator.init(); return; }
                
                // Metis Session Controls
                const sessionView = target.closest('#metis-session');
                if(sessionView){
                    if (target.closest('#back-to-dashboard-btn')) { UI.showConfirm("세션을 중단하고 돌아가시겠습니까?", () => document.dispatchEvent(new CustomEvent('sessionComplete', { detail: { finished: false } }))); return; }
                    if (target.closest('.next-step-btn')) { MetisSession.proceed(); return; }
                    if (target.id === 'finish-reading-btn') { MetisSession.handleFocusEnd(); return; }
                    if (target.id === 'start-next-cycle-btn') { MetisSession.handleBreakEnd(); return; }
                    if (target.id === 'finish-session-btn') { MetisSession.complete(); return; }
                }

                // Garden and Dashboard Modal Controls
                const plantCard = target.closest('.plant-card');
                if (plantCard) {
                    const plantId = plantCard.dataset.id;
                    currentPlant = Ebbinghaus.getPlantById(plantId);
                    if (!currentPlant) return;
                    if (currentPlant.status === 'healthy') {
                        UI.Dashboard.show(currentPlant, Ebbinghaus.createChartConfig(currentPlant));
                    } else {
                        Ebbinghaus.startReview(plantId);
                    }
                    return;
                }
                if (target.closest('#dashboard-modal-overlay') && !target.closest('.modal-content')) { UI.Dashboard.hide(); return; }
                const simulateBtn = target.closest('#simulate-review-btn');
                if (simulateBtn) {
                    if(!currentPlant) return;
                    const simulatedStrength = currentPlant.strength + 1;
                    const simulatedData = {
                        label: '시뮬레이션: 오늘 복습 시',
                        data: Ebbinghaus.generateCurveData(new Date(), simulatedStrength),
                        borderColor: 'rgba(66, 133, 244, 0.5)', borderDash: [5, 5], tension: 0.4, pointRadius: 0
                    };
                    UI.Dashboard.updateChart(simulatedData);
                    simulateBtn.disabled = true;
                    simulateBtn.textContent = '✅ 시뮬레이션 완료';
                    return;
                }
            });

            document.addEventListener('sessionComplete', (e) => {
                if (e.detail.finished) {
                    Ebbinghaus.plantSeed(e.detail.data);
                }
                MetisSession.reset();
                const view = e.detail.finished ? 'garden' : 'dashboard';
                UI.switchView(view, document.querySelectorAll('.nav-btn'));
                if(view === 'garden') Ebbinghaus.initGarden();
            });

            document.addEventListener('goalSelected', (e) => {
                const { level, text } = e.detail;
                document.querySelector('#main-book-goal').innerHTML = `<strong>🎯 현재 목표 (레벨 ${level})</strong><p>${text}</p>`;
            });
            
            // Initial Load
            UI.switchView('dashboard', document.querySelectorAll('.nav-btn'));
        });
    </script>
</body>
</html>

