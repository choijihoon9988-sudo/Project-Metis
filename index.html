<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Metis: Knowledge Compounding Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4285F4;
            --primary-dark: #3367D6;
            --background-color: #f0f4f9;
            --surface-color: #ffffff;
            --text-color: #3c4043;
            --text-light-color: #5f6368;
            --border-color: #dadce0;
            --font-family: 'Noto Sans KR', sans-serif;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            --border-radius: 8px;
            --unlocked-glow: 0 0 8px rgba(66, 133, 244, 0.5);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 240px; background-color: var(--surface-color); padding: 24px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .sidebar h1 { font-size: 24px; color: var(--primary-color); margin-bottom: 32px; }
        .sidebar nav { display: flex; flex-direction: column; gap: 8px; }
        .nav-btn { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--border-radius); border: none; background-color: transparent; cursor: pointer; text-align: left; font-size: 16px; font-weight: 500; color: var(--text-light-color); transition: background-color 0.2s, color 0.2s; }
        .nav-btn .icon { font-size: 20px; }
        .nav-btn:hover { background-color: var(--background-color); }
        .nav-btn.active { background-color: #E8F0FE; color: var(--primary-dark); }
        .main-content { flex: 1; overflow-y: auto; padding: 32px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        .view-header { margin-bottom: 24px; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
        .view-header h2 { font-size: 28px; margin-bottom: 4px; }
        .view-header p { color: var(--text-light-color); font-size: 16px; }
        .card { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 24px; margin-bottom: 24px; }
        .btn { padding: 10px 20px; font-size: 16px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--surface-color); cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn:hover { background-color: #f1f3f4; }
        .btn.active { background-color: #E8F0FE; color: var(--primary-dark); border-color: var(--primary-color); }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-secondary { background-color: transparent; color: var(--text-light-color); border: none; }
        .btn-secondary:hover { background-color: #f1f3f4; color: var(--text-color); }
        textarea, input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-family: var(--font-family); font-size: 16px; margin-bottom: 16px; }
        textarea:focus, input[type="text"]:focus { outline: 2px solid var(--primary-color); border-color: var(--primary-color); }
        textarea { min-height: 120px; resize: vertical; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .main-book-slot { grid-column: 1 / 2; grid-row: 1 / 3; }
        .book-info { display: flex; gap: 20px; margin-bottom: 24px; }
        .book-cover { width: 150px; height: auto; object-fit: cover; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .book-details h4 { font-size: 20px; }
        .book-details .goal { margin-top: 16px; }
        .main-book-slot .btn-primary { width: 100%; padding: 16px; font-size: 18px; }
        .sub-book-shelf-container { grid-column: 2 / 3; }
        .sub-book-shelf { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; }
        .sub-book-cover { height: 120px; border-radius: 4px; box-shadow: var(--shadow); }
        .ai-assistant-slot .book-title-input { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        .storage-controls { display: flex; gap: 12px; margin-bottom: 24px; padding: 16px; }
        .storage-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 24px; }
        .capsule { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); padding: 16px; transition: all 0.2s; display: flex; flex-direction: column; }
        .capsule-title { font-weight: 700; margin-bottom: 8px; flex-grow: 1; }
        .capsule-source { font-size: 14px; color: var(--text-light-color); margin-bottom: 12px; }
        .capsule-status { font-size: 14px; font-weight: 500; text-align: center; padding: 8px; border-radius: 4px; margin-top: auto; }
        .capsule.locked { background-color: #f8f9fa; color: #80868b; }
        .capsule.locked .capsule-status { background-color: #e8eaed; }
        .capsule.unlocked { cursor: pointer; border-color: var(--primary-color); box-shadow: var(--unlocked-glow); }
        .capsule.unlocked:hover { transform: translateY(-5px); box-shadow: var(--shadow), var(--unlocked-glow); }
        .capsule.unlocked .capsule-status { background-color: #E8F0FE; color: var(--primary-dark); }
        .empty-message { text-align: center; color: var(--text-light-color); grid-column: 1 / -1; padding: 40px; }
        .session-content { max-width: 800px; margin: 0 auto; }
        .goal-display { background-color: var(--background-color); border-left: 4px solid var(--primary-color); padding: 16px; margin-bottom: 24px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s; }
        .step h4 { font-size: 22px; margin-bottom: 16px; }
        #timer { font-size: 48px; font-weight: 700; text-align: center; color: var(--primary-dark); margin: 24px 0; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .comparison-col h5 { margin-bottom: 8px; color: var(--text-light-color); }
        .comparison-content { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; min-height: 150px; overflow-y: auto; }
        textarea.final-writing { min-height: 250px; }
        .loader-overlay, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .loader { border: 6px solid rgba(255,255,255,0.3); border-top: 6px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        .loader-text { color: white; margin-top: 16px; font-size: 16px; }
        .modal-content { background: var(--surface-color); padding: 32px; border-radius: var(--border-radius); width: 90%; max-width: 700px; animation: fadeIn 0.3s; }
        .modal-controls { margin-top: 24px; display: flex; justify-content: flex-end; gap: 8px; }
        .challenge-title { font-size: 22px; color: var(--primary-dark); margin-bottom: 8px; }
        .challenge-description { color: var(--text-light-color); margin-bottom: 16px; }
        .challenge-prompt { background-color: var(--background-color); border-left: 4px solid var(--primary-color); padding: 16px; margin: 24px 0; border-radius: 4px; font-style: italic; }
        .confidence-rating { margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 16px; }
        #goal-navigator-modal .modal-header { text-align: center; margin-bottom: 24px; }
        .mode-selection-container { display: flex; justify-content: space-around; gap: 20px; }
        .mode-select-btn { flex: 1; padding: 20px; text-align: center; border: 2px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s; }
        .mode-select-btn:hover { border-color: var(--primary-color); background-color: #E8F0FE; }
        .goal-pack-container { max-height: 40vh; overflow-y: auto; padding: 8px; }
        .goal-card { background: var(--background-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; margin-bottom: 12px; cursor: pointer; }
        .goal-card:hover { border-color: var(--primary-color); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--text-color); color: white; padding: 12px 24px; border-radius: var(--border-radius); z-index: 2000; animation: toast-in 0.5s, toast-out 0.5s 2.5s; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-in { from { bottom: -50px; opacity: 0; } to { bottom: 20px; opacity: 1; } }
        @keyframes toast-out { from { bottom: 20px; opacity: 1; } to { bottom: -50px; opacity: 0; } }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <h1>Project Metis</h1>
            <nav>
                <button class="nav-btn active" data-view="dashboard">
                    <span class="icon">🏠</span> 대시보드
                </button>
                <button class="nav-btn" data-view="storage">
                    <span class="icon">📦</span> 지식 타임캡슐
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <!-- ============== Dashboard View ============== -->
            <div id="dashboard" class="view active">
                <header class="view-header">
                    <h2>오늘의 지식 탐험</h2>
                    <p>메인북을 중심으로 새로운 지식을 탐험하고, 당신의 자산으로 만드세요.</p>
                </header>
                <div class="dashboard-grid">
                    <div id="main-book-slot" class="main-book-slot card">
                        <h3>📘 메인북</h3>
                        <div class="book-info">
                            <img src="https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1593003033l/54495910.jpg" alt="Nudge book cover" class="book-cover">
                            <div class="book-details">
                                <h4>넛지 (Nudge)</h4>
                                <p>리처드 H. 탈러, 캐스 R. 선스타인</p>
                                <div id="main-book-goal" class="goal">
                                    <strong>🎯 현재 목표 (레벨 2)</strong>
                                    <p>선택 설계의 3요소(디폴트, 피드백, 오류 예상)를 설명하고, 실생활 사례 1가지씩 찾아보기.</p>
                                </div>
                            </div>
                        </div>
                        <button id="start-session-btn" class="btn btn-primary">새로운 지식 탐험하기 (메티스 세션)</button>
                    </div>
                    <div class="ai-assistant-slot card">
                        <h3>🤖 AI 목표 내비게이터</h3>
                        <p>책을 통해 무엇을 얻고 싶으신가요? AI가 최적의 학습 목표 설정을 도와드립니다.</p>
                        <div class="book-title-input">
                            <label for="book-title-for-goal">대상 도서:</label>
                            <input type="text" id="book-title-for-goal" value="넛지 (Nudge)" placeholder="책 제목을 입력하세요">
                        </div>
                        <button id="start-goal-navigator-btn" class="btn">AI 목표 설정 시작하기</button>
                    </div>
                    <div class="sub-book-shelf-container card">
                        <h3>📚 관심 서재 (서브북)</h3>
                        <div class="sub-book-shelf">
                            <img src="https://image.aladin.co.kr/product/30883/29/cover500/k252830635_1.jpg" alt="Book cover 1" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/10/3/cover500/8932917248_2.jpg" alt="Book cover 2" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/33359/29/cover500/k252938250_1.jpg" alt="Book cover 3" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/1324/3/cover500/890120935x_1.jpg" alt="Book cover 4" class="sub-book-cover"><img src="https://image.aladin.co.kr/product/29306/17/cover500/s972837389_1.jpg" alt="Book cover 5" class="sub-book-cover">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ============== Knowledge Capsule View ============== -->
            <div id="storage" class="view">
                <header class="view-header">
                    <h2>📦 지식 타임캡슐</h2>
                    <p>당신의 모든 지식 자산이 보관되어 있습니다. 개봉일이 되면 자동으로 잠금 해제됩니다.</p>
                </header>
                <div class="storage-controls card">
                    <button class="btn filter-btn active" data-filter="unlocked">🔑 오늘의 복습</button>
                    <button class="btn filter-btn" data-filter="all">📂 전체 캡슐</button>
                    <button class="btn filter-btn" data-filter="locked">🔒 잠긴 캡슐</button>
                </div>
                <div id="storage-container" class="storage-container">
                    <!-- Capsules will be rendered here -->
                </div>
            </div>

            <!-- ============== Metis Session View ============== -->
            <div id="metis-session" class="view">
                 <header class="view-header">
                     <button id="back-to-dashboard-btn" class="btn btn-secondary">← 뒤로가기</button>
                     <h2>🧠 메티스 학습 세션</h2>
                     <p id="step-title">단계 1: 학습 예측</p>
                 </header>
                 <div class="session-content">
                     <!-- Step 1: Prediction -->
                     <div id="step-1" class="step active card">
                         <div id="session-goal-display" class="goal-display card"></div>
                         <h4>[1/7] 학습 예측 (Prediction)</h4>
                         <p>위 목표와 관련하여 책에서 어떤 내용을 다룰 것 같습니까? 핵심 내용을 예측해보세요.</p>
                         <textarea id="prediction-input" placeholder="예: 넛지의 개념을 설명하고, 사람들의 비합리적 선택을 유도하는 사례를 보여줄 것 같다."></textarea>
                         <button class="btn btn-primary next-step-btn" data-next="2">예측 완료, 집중 독서 시작</button>
                     </div>

                     <!-- Step 2: Focused Reading -->
                     <div id="step-2" class="step card">
                         <h4>[2/7] 집중 독서 (Focused Reading)</h4>
                         <p>이제 25분간 목표에만 집중하여 책을 읽습니다. 몰입을 위해 방해 요소를 제거하세요.</p>
                         <div id="timer">25:00</div>
                         <button class="btn btn-primary next-step-btn" data-next="3">독서 완료, 생각 기록하기</button>
                     </div>

                     <!-- Step 3: Brain Dump -->
                     <div id="step-3" class="step card">
                         <h4>[3/7] 생각 기록 (Brain Dump)</h4>
                         <p>방금 읽은 내용과 그에 대한 당신의 생각을 5분간 자유롭게 기록하세요.</p>
                         <textarea id="braindump-input" placeholder="정리되지 않아도 괜찮습니다. 떠오르는 모든 것을 기록하세요."></textarea>
                         <button class="btn btn-primary next-step-btn" data-next="4">기록 완료, AI 피드백 예측하기</button>
                     </div>
                     
                     <!-- Step 4: Metacognition -->
                     <div id="step-4" class="step card">
                        <h4>[4/7] AI 피드백 예측 (Metacognition)</h4>
                        <p>AI가 당신의 기록에 대해 어떤 피드백을 줄 것 같습니까? 당신이 놓친 부분이나 잘못 이해한 부분은 무엇일까요?</p>
                        <textarea id="ai-prediction-input" placeholder="예: 개념 설명은 잘했지만, 각 요소가 어떻게 상호작용하는지에 대한 설명이 부족하다고 지적할 것 같다."></textarea>
                        <button class="btn btn-primary next-step-btn" data-next="5">예측 완료, 결과 확인하기</button>
                    </div>

                    <!-- Step 5: The Reveal -->
                    <div id="step-5" class="step card">
                        <h4>[5/7] 비교 분석 (The Reveal)</h4>
                        <p>자신의 이해도와 실제 이해도 사이의 격차(Gap)를 객관적으로 인지하세요.</p>
                        <div class="comparison-grid">
                            <div class="comparison-col"><h5>🤔 내 생각</h5><div id="reveal-my-thoughts" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5>🤖 AI 피드백</h5><div id="reveal-ai-feedback" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5>🔮 내 예측</h5><div id="reveal-my-prediction" class="comparison-content"></div></div>
                            <div class="comparison-col"><h5> A 전문가 요약</h5><div id="reveal-expert-summary" class="comparison-content"></div></div>
                        </div>
                        <button class="btn btn-primary next-step-btn" data-next="6">분석 완료, 핵심 질문 추출하기</button>
                    </div>

                    <!-- Step 6: Gap Analysis -->
                    <div id="step-6" class="step card">
                        <h4>[6/7] 글쓰기를 위한 핵심 질문 추출</h4>
                        <p>당신의 생각과 AI의 분석 사이에서 발견한 '격차(Gap)'는 무엇이었나요? 이 격차를 해소하는 것이 바로 글의 주제가 됩니다. 가장 핵심적인 질문 하나를 뽑아보세요.</p>
                        <textarea id="gap-input" placeholder="예: 나는 개념의 나열에 그쳤지만, AI는 '개념 간의 연결성 부족'을 지적했다. 그렇다면, 각 개념들은 어떻게 유기적으로 연결되는가?"></textarea>
                        <button class="btn btn-primary next-step-btn" data-next="7">질문 추출 완료, 체화 글쓰기 시작</button>
                    </div>

                     <!-- Step 7: Final Writing -->
                     <div id="step-7" class="step card">
                         <h4>[7/7] 완벽한 체화를 위한 글쓰기</h4>
                         <p>축하합니다! 이제 마지막 단계입니다. 방금 추출한 질문에 대한 답을 스스로 설명하는 한 편의 글을 완성하세요. 이 과정에서 당신의 지식은 비로소 응용 가능한 자산이 됩니다.</p>
                         <textarea id="final-writing-input" class="final-writing" placeholder="6단계에서 뽑아낸 질문을 바탕으로, 오늘 배운 내용을 다른 사람에게 설명하듯 자유롭게 글을 작성해보세요."></textarea>
                         <button id="finish-session-btn" class="btn btn-primary">글쓰기 완료, 지식 타임캡슐 봉인</button>
                     </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- ============== Modals ============== -->
    <div id="loader" class="loader-overlay">
        <div class="loader"></div>
        <div class="loader-text">AI가 당신의 생각을 분석 중입니다...</div>
    </div>
    <div id="challenge-modal-overlay" class="modal-overlay">
        <div id="challenge-modal" class="modal-content"></div>
    </div>
    <div id="goal-navigator-modal-overlay" class="modal-overlay">
        <div id="goal-navigator-modal" class="modal-content">
            <div id="goal-navigator-content"></div>
        </div>
    </div>

    <script type="module">
        // ------------------- UI Module -------------------
        const UI = {
            switchView(viewName, navButtons) {
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                document.getElementById(viewName)?.classList.add('active');
                navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName));
            },
            switchStep(stepNumber) {
                document.querySelectorAll('#metis-session .step').forEach(step => step.classList.remove('active'));
                const el = document.getElementById(`step-${stepNumber}`);
                if (el) {
                    el.classList.add('active');
                    document.getElementById('step-title').textContent = el.querySelector('h4').textContent;
                }
            },
            updateTimerDisplay(timeLeft) {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timerEl = document.getElementById('timer');
                if (timerEl) timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },
            renderCapsules(capsulesToRender, filter) {
                const container = document.getElementById('storage-container');
                if (!container) return;
                container.innerHTML = '';
                if (capsulesToRender.length === 0) {
                    let message = '🚀 아직 보관된 지식 캡슐이 없습니다.';
                    if (filter === 'unlocked') message = '👍 오늘의 복습 미션이 없습니다!';
                    else if (filter === 'locked') message = '🤔 아직 잠겨있는 캡슐이 없습니다.';
                    container.innerHTML = `<p class="empty-message">${message}</p>`;
                    return;
                }
                capsulesToRender.sort((a, b) => b.id - a.id).forEach(capsule => {
                    const el = document.createElement('div');
                    el.className = `capsule ${capsule.state}`;
                    el.dataset.id = capsule.id;
                    const statusHTML = capsule.state === 'locked' ? `🔒 ${capsule.daysUntilUnlock}일 후 개봉` : `🔑 지금 복습하기`;
                    el.innerHTML = `<div class="capsule-title">${capsule.title}</div><div class="capsule-source">출처: ${capsule.sourceBook}</div><div class="capsule-status">${statusHTML}</div>`;
                    container.appendChild(el);
                });
            },
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },
            showConfirm(message, onConfirm) {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.style.display = 'flex';
                const modal = document.createElement('div');
                modal.className = 'modal-content';
                modal.innerHTML = `<p>${message}</p><div class="modal-controls"><button id="confirm-cancel" class="btn">취소</button><button id="confirm-ok" class="btn btn-primary">확인</button></div>`;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                overlay.onclick = (e) => {
                    if (e.target.id === 'confirm-ok') onConfirm();
                    if (e.target.closest('#confirm-cancel') || e.target.closest('#confirm-ok') || e.target === overlay) overlay.remove();
                };
            },
            showChallenge(capsule, onComplete) {
                const overlay = document.getElementById('challenge-modal-overlay');
                const content = document.getElementById('challenge-modal');
                content.innerHTML = `<h3 class="challenge-title">캡슐 개봉: 복습 챌린지</h3><p class="challenge-description">"${capsule.sourceBook}"에서 배운 내용을 떠올려보세요.</p><div class="challenge-prompt">${capsule.question.replace(/\n/g, '<br>')}</div><textarea id="challenge-answer" placeholder="당신의 언어로 자유롭게 설명해보세요..."></textarea><div class="confidence-rating"><p>이번 답변에 얼마나 확신했나요?</p><div class="confidence-buttons"><button class="btn" data-confidence="confident">✅ 확신함</button><button class="btn" data-confidence="unsure">🤔 긴가민가함</button><button class="btn" data-confidence="guess">❓ 거의 추측함</button></div></div><div class="challenge-controls"><button id="challenge-cancel-btn" class="btn">취소</button><button id="challenge-submit-btn" class="btn btn-primary" disabled>복습 완료</button></div>`;
                overlay.style.display = 'flex';
                let selectedConfidence = null;
                content.onclick = (e) => {
                    const confidenceBtn = e.target.closest('.confidence-buttons .btn');
                    if (confidenceBtn) {
                        content.querySelectorAll('.confidence-buttons .btn').forEach(b => b.classList.remove('active'));
                        confidenceBtn.classList.add('active');
                        selectedConfidence = confidenceBtn.dataset.confidence;
                        content.querySelector('#challenge-submit-btn').disabled = false;
                    } else if (e.target.id === 'challenge-cancel-btn') this.hideChallenge();
                    else if (e.target.id === 'challenge-submit-btn' && selectedConfidence) onComplete(selectedConfidence);
                };
            },
            hideChallenge() { document.getElementById('challenge-modal-overlay').style.display = 'none'; },
            GoalNavigator: {
                overlay: document.getElementById('goal-navigator-modal-overlay'),
                content: document.getElementById('goal-navigator-content'),
                show() { this.overlay.style.display = 'flex'; },
                hide() { this.overlay.style.display = 'none'; },
                render(step, data) {
                    let html = '';
                    switch (step) {
                        case 'modeSelection': html = `<div class="modal-header"><h3>AI 목표 내비게이터</h3><p><strong>${data.bookTitle}</strong>에 대한 학습 목표 설정을 시작합니다.<br>어떤 방식으로 목표를 설정하시겠습니까?</p></div><div class="mode-selection-container"><div class="mode-select-btn" data-mode="explorer"><div class="icon">🧭</div><h4>탐험가 모드</h4><p>AI가 생성한 목표 팩에서<br>체계적으로 선택합니다.</p></div><div class="mode-select-btn" data-mode="solver"><div class="icon">🛠️</div><h4>해결사 모드</h4><p>해결하고 싶은 문제를 입력하고<br>맞춤형 목표를 생성합니다.</p></div></div>`; break;
                        case 'explorer': html = `<div class="modal-header"><h3>🧭 탐험가 모드</h3><p>AI가 생성한 목표 팩입니다. 가장 마음에 드는 목표를 선택하세요.</p></div><div class="goal-pack-container">${data.goalPack.map(goal => `<div class="goal-card" data-level="${goal.level}" data-text="${goal.text}"><strong>[레벨 ${goal.level}]</strong> ${goal.text}</div>`).join('')}</div>`; break;
                        case 'solver': html = `<div class="modal-header"><h3>🛠️ 해결사 모드</h3><p>이 책을 통해 해결하고 싶은 당신의 문제를 구체적으로 알려주세요.</p></div><div class="solver-chat"><textarea id="solver-problem-input" placeholder="예: 곧 중요한 면접이 있는데, 면접관의 의도를 파악하고 좋은 인상을 남기고 싶어요."></textarea></div><div class="modal-controls"><button id="solver-submit-problem" class="btn btn-primary">문제 제출하고 목표 생성</button></div>`; break;
                        case 'architect': html = `<div class="modal-header"><h3>✅ 목표 확정 및 개인화</h3><p>AI가 제안한 목표입니다. 자유롭게 수정하여 당신만의 최종 미션으로 확정하세요.</p></div><div class="architect-editor"><textarea id="architect-goal-editor">${data.text}</textarea></div><div class="modal-controls"><button id="architect-confirm-goal" class="btn btn-primary">나의 메인 목표로 설정</button></div>`; break;
                    }
                    this.content.innerHTML = html;
                }
            },
            showLoader(show) {
                document.getElementById('loader').style.display = show ? 'flex' : 'none';
            }
        };

        // ------------------- Metis Session Module -------------------
        const MetisSession = {
            state: {},
            initialState: { currentStep: 1, userInputs: { prediction: '', brainDump: '', aiPrediction: '', gap: '', finalWriting: '' }, timerInterval: null, timeLeft: 25 * 60, sourceBook: '', initialGoal: '' },
            
            init() {
                this.reset();
                this.state.sourceBook = document.querySelector('#main-book-slot h4').textContent;
                this.state.initialGoal = document.querySelector('#main-book-goal p').textContent;
                document.getElementById('session-goal-display').innerHTML = document.getElementById('main-book-goal').innerHTML;
                UI.switchStep(1);
            },
            reset() {
                clearInterval(this.state.timerInterval);
                this.state = JSON.parse(JSON.stringify(this.initialState));
                UI.updateTimerDisplay(this.state.timeLeft);
            },
            startTimer() {
                if (this.state.timerInterval) clearInterval(this.state.timerInterval);
                this.state.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    UI.updateTimerDisplay(this.state.timeLeft);
                    if (this.state.timeLeft <= 0) {
                        clearInterval(this.state.timerInterval);
                        UI.showToast("집중 독서 시간이 종료되었습니다!", "success");
                        this.nextStep(3);
                    }
                }, 1000);
            },
            async nextStep(next) {
                const { currentStep, userInputs } = this.state;
                if (currentStep === 1) userInputs.prediction = document.getElementById('prediction-input').value;
                if (currentStep === 3) userInputs.brainDump = document.getElementById('braindump-input').value;
                if (currentStep === 4) userInputs.aiPrediction = document.getElementById('ai-prediction-input').value;
                if (currentStep === 6) userInputs.gap = document.getElementById('gap-input').value;
                
                if (next === 2) this.startTimer();

                if (next === 5) {
                    UI.showLoader(true);
                    const [feedback, summary] = await Promise.all([this.getAIFeedback(userInputs.brainDump), this.getExpertSummary()]);
                    document.getElementById('reveal-my-thoughts').textContent = userInputs.brainDump;
                    document.getElementById('reveal-ai-feedback').textContent = feedback;
                    document.getElementById('reveal-my-prediction').textContent = userInputs.aiPrediction;
                    document.getElementById('reveal-expert-summary').textContent = summary;
                    UI.showLoader(false);
                }

                this.state.currentStep = next;
                UI.switchStep(next);
            },
            complete() {
                this.state.userInputs.finalWriting = document.getElementById('final-writing-input').value;
                if (!this.state.userInputs.gap || !this.state.userInputs.finalWriting) {
                    UI.showToast('핵심 질문과 체화 글쓰기를 모두 작성해야 캡슐을 보관할 수 있습니다.', 'error');
                    return;
                }
                document.dispatchEvent(new CustomEvent('sessionComplete', { detail: { finished: true, capsuleData: this.state } }));
            },
            // API Mocks
            simulateApiCall: (data, delay = 1500) => new Promise(resolve => setTimeout(() => resolve(data), delay)),
            getAIFeedback(text) {
                const feedback = `전체적으로 핵심 내용을 잘 파악하고 계십니다. 다만, 각 개념 간의 '연결성'을 좀 더 명확하게 설명하면 논리가 강화될 것입니다. 저자의 핵심 주장은 단순히 개념을 나열하는 것이 아니라, 그 인과관계를 통해 독자를 설득하는 데 있다는 점을 기억하세요.`;
                return this.simulateApiCall(feedback);
            },
            getExpertSummary() {
                const summary = `**넛지(Nudge): 선택 설계의 힘**\n\n인간은 항상 합리적으로 선택하지 않는다. 이 책의 저자들은 사람들이 더 나은 결정을 내리도록 부드럽게 개입하는 '선택 설계'의 중요성을 강조합니다. 핵심 도구는 디폴트 설정, 오류 예상, 그리고 즉각적인 피드백입니다.`;
                return this.simulateApiCall(summary);
            }
        };

        // ------------------- Ebbinghaus Module -------------------
        const Ebbinghaus = {
            capsules: [],
            getReviewIntervalDays(strength) {
                if (strength <= 1) return 1; if (strength === 2) return 3; if (strength === 3) return 7;
                return Math.round(this.getReviewIntervalDays(strength - 1) * 2.1);
            },
            load() {
                const stored = localStorage.getItem('knowledgeCapsules');
                this.capsules = stored ? JSON.parse(stored) : [];
                this.capsules.forEach(c => {
                    if (!c.reviews) c.reviews = [{ date: new Date().toISOString(), confidence: 'confident' }];
                    this.calculateState(c);
                });
            },
            calculateState(capsule) {
                const now = new Date(); now.setHours(0, 0, 0, 0);
                const lastReviewed = new Date(capsule.reviews[capsule.reviews.length - 1].date);
                const interval = this.getReviewIntervalDays(capsule.strength);
                const nextReviewDate = new Date(lastReviewed);
                nextReviewDate.setDate(lastReviewed.getDate() + interval);
                nextReviewDate.setHours(0, 0, 0, 0);
                capsule.state = (now >= nextReviewDate) ? 'unlocked' : 'locked';
                if (capsule.state === 'locked') {
                    capsule.daysUntilUnlock = Math.ceil(Math.abs(nextReviewDate - now) / (1000 * 60 * 60 * 24));
                }
            },
            startReview(capsuleId) {
                const capsule = this.capsules.find(c => c.id == capsuleId);
                if (!capsule) return;
                UI.showChallenge(capsule, (confidence) => {
                    capsule.reviews.push({ date: new Date().toISOString(), confidence });
                    if (confidence === 'confident') capsule.strength++;
                    else if (confidence === 'guess') capsule.strength = Math.max(1, capsule.strength - 1);
                    localStorage.setItem('knowledgeCapsules', JSON.stringify(this.capsules));
                    UI.hideChallenge();
                    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                    this.init(activeFilter);
                });
            },
            plantCapsule(sessionData) {
                const { initialGoal, sourceBook, finalWriting, gap } = sessionData.userInputs;
                const newCapsule = { id: Date.now(), title: initialGoal.substring(0, 40) + '...', sourceBook, question: `[핵심 질문] ${gap}\n\n위 질문에 대해 당신이 체화한 지식을 설명하세요.`, answer: finalWriting, strength: 1, reviews: [{ date: new Date().toISOString(), confidence: 'confident' }] };
                if (!this.capsules.some(c => c.question.includes(gap))) {
                    this.capsules.push(newCapsule);
                    localStorage.setItem('knowledgeCapsules', JSON.stringify(this.capsules));
                    UI.showToast("새로운 지식 타임캡슐을 봉인했습니다!", "success");
                } else {
                    UI.showToast("이미 동일한 질문의 캡슐이 존재합니다.", "error");
                }
            },
            init(filter = 'unlocked') {
                this.load();
                const filtered = filter === 'all' ? this.capsules : this.capsules.filter(c => c.state === filter);
                UI.renderCapsules(filtered, filter);
            }
        };

        // ------------------- Goal Navigator Module -------------------
        const GoalNavigator = {
            state: {},
            init() {
                const bookTitleEl = document.getElementById('book-title-for-goal');
                const bookTitle = bookTitleEl ? bookTitleEl.value : '';
                if (!bookTitle.trim()) { UI.showToast('목표를 설정할 책 제목을 먼저 입력해주세요!', 'error'); bookTitleEl.focus(); return; }
                this.state = { bookTitle, mode: null, selectedGoal: null };
                UI.GoalNavigator.content.removeEventListener('click', this.handleEvents);
                UI.GoalNavigator.content.addEventListener('click', this.handleEvents.bind(this));
                this.render('modeSelection', { bookTitle });
                UI.GoalNavigator.show();
            },
            handleEvents(event) {
                const target = event.target;
                const modeButton = target.closest('.mode-select-btn');
                if (modeButton) { this.selectMode(modeButton.dataset.mode); return; }
                const goalCard = target.closest('.goal-card');
                if (goalCard) { this.state.selectedGoal = { level: goalCard.dataset.level, text: goalCard.dataset.text }; this.render('architect', this.state.selectedGoal); return; }
                const solverSubmitBtn = target.closest('#solver-submit-problem');
                if (solverSubmitBtn) {
                    const problemInput = document.getElementById('solver-problem-input');
                    if (!problemInput.value.trim()) { UI.showToast('해결하고 싶은 문제를 입력해주세요.', 'error'); problemInput.focus(); return; }
                    this.state.selectedGoal = this.getSolverGoal(this.state.bookTitle, problemInput.value);
                    this.render('architect', this.state.selectedGoal);
                    return;
                }
                const architectConfirmBtn = target.closest('#architect-confirm-goal');
                if (architectConfirmBtn) {
                    this.state.selectedGoal.text = document.getElementById('architect-goal-editor').value;
                    document.dispatchEvent(new CustomEvent('goalSelected', { detail: this.state.selectedGoal }));
                    UI.GoalNavigator.hide();
                    return;
                }
            },
            render(stepName, data = {}) { UI.GoalNavigator.render(stepName, data); },
            selectMode(mode) {
                this.state.mode = mode;
                if (mode === 'explorer') this.render('explorer', { goalPack: this.getGoalPackForBook(this.state.bookTitle) });
                else if (mode === 'solver') this.render('solver');
            },
            getGoalPackForBook: (bookTitle) => [{ level: 1, text: `'${bookTitle}'에서 '핵심 개념 A'의 정의를 찾고, 실생활 사례 1가지 찾아보기.` }, { level: 2, text: `'${bookTitle}'의 1부에서 설명하는 '주요 원칙 3가지'를 활용하여, 나의 현재 문제를 해결할 구체적인 액션 플랜 작성하기.` }],
            getSolverGoal: (bookTitle, problem) => ({ level: 2, text: `'${bookTitle}'의 내용을 활용하여, '${problem.substring(0, 20)}...' 문제를 해결하기 위한 3가지 실행 가능한 전략을 도출하시오.` })
        };

        // ------------------- Main Application Logic -------------------
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.querySelector('.app-container');
            
            appContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('.nav-btn')) {
                    const viewName = target.closest('.nav-btn').dataset.view;
                    UI.switchView(viewName, document.querySelectorAll('.nav-btn'));
                    if (viewName === 'storage') Ebbinghaus.init();
                }
                else if (target.closest('#start-session-btn')) {
                    UI.switchView('metis-session', document.querySelectorAll('.nav-btn'));
                    MetisSession.init();
                }
                else if (target.closest('#start-goal-navigator-btn')) GoalNavigator.init();
                else if (target.closest('#metis-session .next-step-btn')) MetisSession.nextStep(parseInt(target.closest('.next-step-btn').dataset.next, 10));
                else if (target.closest('#finish-session-btn')) MetisSession.complete();
                else if (target.closest('#back-to-dashboard-btn')) UI.showConfirm("세션을 중단하고 돌아가시겠습니까?", () => document.dispatchEvent(new CustomEvent('sessionComplete', { detail: { finished: false } })));
                else if (target.closest('.filter-btn')) {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    target.closest('.filter-btn').classList.add('active');
                    Ebbinghaus.init(target.closest('.filter-btn').dataset.filter);
                }
                else if (target.closest('.capsule.unlocked')) Ebbinghaus.startReview(target.closest('.capsule.unlocked').dataset.id);
            });

            document.addEventListener('sessionComplete', (e) => {
                if (e.detail.finished) Ebbinghaus.plantCapsule(e.detail.capsuleData);
                MetisSession.reset();
                const view = e.detail.finished ? 'storage' : 'dashboard';
                UI.switchView(view, document.querySelectorAll('.nav-btn'));
                if(view === 'storage') Ebbinghaus.init();
            });

            document.addEventListener('goalSelected', (e) => {
                const { level, text } = e.detail;
                document.querySelector('#main-book-goal').innerHTML = `<strong>🎯 현재 목표 (레벨 ${level})</strong><p>${text}</p>`;
            });
            
            // Initial Load
            UI.switchView('dashboard', document.querySelectorAll('.nav-btn'));
        });
    </script>
</body>
</html>

